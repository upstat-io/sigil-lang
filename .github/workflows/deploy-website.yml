name: Deploy Website

on:
  # Deploy after CI completes on master (includes PR merges)
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read  # Needed to download artifacts from other workflows

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation

      - name: Fetch test results from CI
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          branch: master
          name: test-results
          path: website/public
          run_id: ${{ github.event.workflow_run.id }}
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Fetch LLVM test results from CI
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          branch: master
          name: llvm-test-results
          path: website/public
          run_id: ${{ github.event.workflow_run.id }}
          if_no_artifact_found: warn
        continue-on-error: true

      - name: Merge test results
        run: |
          cd website/public
          # Create default if missing
          if [ ! -f test-results.json ]; then
            echo '{"rust_tests": 0, "ori_tests": 0, "rust_failed": 0, "ori_failed": 0}' > test-results.json
          fi
          # Only merge LLVM results if artifact was actually downloaded;
          # don't create default zeros that overwrite existing data
          if [ -f llvm-test-results.json ]; then
            jq -s '.[0] * .[1]' test-results.json llvm-test-results.json > combined-test-results.json
            mv combined-test-results.json test-results.json
            rm -f llvm-test-results.json
          else
            echo "LLVM test results artifact not found, preserving existing data"
            # Add default llvm keys only if they don't already exist
            if ! jq -e '.llvm_tests' test-results.json > /dev/null 2>&1; then
              jq '. + {"llvm_tests": 0, "llvm_failed": 0}' test-results.json > tmp.json && mv tmp.json test-results.json
            fi
          fi
          echo "Test results:"
          cat test-results.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: website/playground-wasm -> website/playground-wasm/target
          cache-on-failure: true

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0

      - name: Derive build number
        run: ./scripts/bump-build.sh

      - name: Build WASM
        run: |
          cd website/playground-wasm
          wasm-pack build --target web --out-dir pkg --release

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install website dependencies
        run: bun install
        working-directory: website

      - name: Copy WASM to website
        run: bash scripts/copy-wasm.sh
        working-directory: website

      - name: Generate changelog
        run: bash scripts/generate-changelog.sh
        working-directory: website

      - name: Build website
        run: bun run build
        working-directory: website

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: website/dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
