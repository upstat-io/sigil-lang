---
import { getCollection } from 'astro:content';
import Sidebar from '../common/Sidebar.astro';

const spec = await getCollection('spec');
const compilerDesign = await getCollection('compiler-design');
const formatter = await getCollection('formatter');
const lsp = await getCollection('lsp');

// Helper to transform collection items
const toSidebarItems = (items: any[]) =>
  items.map(item => ({ id: item.id, title: item.data.title }));

// Helper to group by section
const groupBySection = (items: any[], sectionNames: string[]) =>
  sectionNames
    .map(name => ({
      name,
      items: toSidebarItems(
        items
          .filter(d => d.data.section === name)
          .sort((a, b) => a.data.order - b.data.order)
      ),
    }))
    .filter(g => g.items.length > 0);

// Build sections config
const sections = [
  {
    title: 'Specification',
    basePath: '/docs/spec',
    items: toSidebarItems(
      spec
        .filter(d => !d.data.section)
        .sort((a, b) => a.data.order - b.data.order)
    ),
    subsections: groupBySection(spec, [
      'Foundations',
      'Types & Values',
      'Declarations',
      'Expressions',
      'Execution',
      'Verification',
      'Tooling',
    ]),
  },
  {
    title: 'Compiler Design',
    basePath: '/docs/compiler-design',
    items: toSidebarItems(
      compilerDesign
        .filter(d => !d.data.section)
        .sort((a, b) => a.data.order - b.data.order)
    ),
    subsections: groupBySection(compilerDesign, [
      'Architecture',
      'Intermediate Representation',
      'Lexer',
      'Parser',
      'Type System',
      'Pattern System',
      'Evaluator',
      'Diagnostics',
      'Testing',
      'LLVM Backend',
      'Appendices',
    ]),
  },
  {
    title: 'Formatter',
    basePath: '/docs/formatter',
    items: toSidebarItems(
      formatter
        .filter(d => !d.data.section)
        .sort((a, b) => a.data.order - b.data.order)
    ),
    subsections: groupBySection(formatter, [
      'Algorithm',
      'Constructs',
      'Comments',
      'Implementation',
      'Appendices',
    ]),
  },
  {
    title: 'LSP',
    basePath: '/docs/lsp',
    items: toSidebarItems(
      lsp
        .filter(d => !d.data.section)
        .sort((a, b) => a.data.order - b.data.order)
    ),
    subsections: groupBySection(lsp, [
      'Protocol',
      'Architecture',
      'Features',
      'Integration',
    ]),
  },
];
---

<Sidebar sections={sections} />
