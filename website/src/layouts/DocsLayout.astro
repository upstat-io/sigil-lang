---
import BaseLayout from './BaseLayout.astro';
import DocsSidebar from '../components/docs/DocsSidebar.astro';

interface Props {
  title: string;
  description?: string;
  section?: string;
}

const { title, description, section } = Astro.props;
const currentPath = Astro.url.pathname;

// Determine the docs section from the URL
const pathParts = currentPath.split('/').filter(Boolean);
const docsSection = pathParts[1] || 'docs'; // spec, compiler-design, formatter, lsp

// Build SEO-optimized description
const seoDescription = description ||
  `Learn about ${title} in the Ori programming language documentation. Comprehensive reference for ${title.toLowerCase()} covering syntax, semantics, and examples.`;

// Build keywords based on section and title
const sectionKeywords: Record<string, string> = {
  'spec': 'Ori specification, language spec, syntax reference, grammar',
  'compiler-design': 'Ori compiler, compiler design, implementation, architecture',
  'formatter': 'Ori formatter, code formatting, style guide, auto-format',
  'lsp': 'Ori LSP, language server, IDE support, editor integration',
};

const keywords = `${title}, Ori docs, ${sectionKeywords[docsSection] || 'Ori documentation'}, programming language reference`;

// Build breadcrumbs
const sectionTitles: Record<string, string> = {
  'spec': 'Specification',
  'compiler-design': 'Compiler Design',
  'formatter': 'Formatter',
  'lsp': 'LSP',
};

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: sectionTitles[docsSection] || 'Docs', url: `/docs/${docsSection}/index` },
  { name: title, url: currentPath },
];
---

<BaseLayout
  title={`${title} â€” Ori ${sectionTitles[docsSection] || 'Docs'}`}
  description={seoDescription}
  keywords={keywords}
  ogType="article"
  breadcrumbs={breadcrumbs}
>
  <div class="docs-layout">
    <DocsSidebar />
    <div class="docs-content">
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <ol class="breadcrumb-list" itemscope itemtype="https://schema.org/BreadcrumbList">
          {breadcrumbs.slice(0, -1).map((crumb, index) => (
            <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
              <a href={crumb.url} itemprop="item">
                <span itemprop="name">{crumb.name}</span>
              </a>
              <meta itemprop="position" content={String(index + 1)} />
              <span class="breadcrumb-sep" aria-hidden="true">/</span>
            </li>
          ))}
          <li class="breadcrumb-item breadcrumb-current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span itemprop="name">{title}</span>
            <meta itemprop="position" content={String(breadcrumbs.length)} />
          </li>
        </ol>
      </nav>
      <article class="docs-article" itemscope itemtype="https://schema.org/TechArticle">
        <meta itemprop="headline" content={title} />
        <meta itemprop="description" content={seoDescription} />
        <meta itemprop="author" content="upstat-io" />
        <div itemprop="articleBody">
          <slot />
        </div>
      </article>
    </div>
  </div>
</BaseLayout>

<style>
  .docs-layout {
    display: flex;
    min-height: calc(100vh - var(--header-height, 56px));
  }

  .docs-content {
    flex: 1;
    min-width: 0;
    padding: var(--space-6, 1.5rem) var(--space-8, 2rem);
    max-width: var(--max-width-narrow, 800px);
    margin: 0 auto;
  }

  .breadcrumb {
    margin-bottom: var(--space-6);
  }

  .breadcrumb-list {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-1);
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: var(--text-sm);
  }

  .breadcrumb-item {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .breadcrumb-item a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .breadcrumb-item a:hover {
    color: var(--color-accent);
  }

  .breadcrumb-sep {
    color: var(--color-border);
  }

  .breadcrumb-current {
    color: var(--color-text-secondary);
  }

  .docs-article {
    line-height: var(--leading-relaxed, 1.65);
  }

  .docs-article :global(h1) {
    margin-bottom: var(--space-6, 1.5rem);
  }

  .docs-article :global(h2) {
    margin-top: var(--space-10, 2.5rem);
    margin-bottom: var(--space-4, 1rem);
    padding-bottom: var(--space-2, 0.5rem);
    border-bottom: 1px solid var(--color-border, #2a2b35);
  }

  .docs-article :global(h3) {
    margin-top: var(--space-8, 2rem);
    margin-bottom: var(--space-3, 0.75rem);
  }

  .docs-article :global(p) {
    margin-bottom: var(--space-4, 1rem);
  }

  .docs-article :global(ul) {
    margin-bottom: var(--space-4, 1rem);
    list-style-type: disc !important;
    list-style-position: outside;
    padding-left: var(--space-6, 1.5rem);
  }

  .docs-article :global(ol) {
    margin-bottom: var(--space-4, 1rem);
    list-style-type: decimal !important;
    list-style-position: outside;
    padding-left: var(--space-6, 1.5rem);
  }

  .docs-article :global(li) {
    display: list-item;
  }

  .docs-article :global(pre) {
    margin-bottom: var(--space-4, 1rem);
  }

  .docs-article :global(table) {
    margin-bottom: var(--space-4, 1rem);
    font-size: var(--text-sm, 0.875rem);
  }

  .docs-article :global(blockquote) {
    margin-bottom: var(--space-4, 1rem);
  }

  @media (max-width: 768px) {
    .docs-layout {
      flex-direction: column;
    }

    .docs-content {
      padding: var(--space-4, 1rem);
    }

    .breadcrumb {
      margin-bottom: var(--space-4);
    }
  }

  /* Mermaid diagram styles */
  .docs-article :global(.mermaid) {
    background: var(--color-bg-secondary, #1a1b26);
    border-radius: var(--radius-md, 8px);
    padding: var(--space-4, 1rem);
    margin-bottom: var(--space-4, 1rem);
    overflow-x: auto;
    text-align: center;
  }

  .docs-article :global(.mermaid svg) {
    max-width: 100%;
    height: auto;
    display: inline-block;
  }
</style>

<script>
  import mermaid from 'mermaid';

  mermaid.initialize({
    startOnLoad: false,
    theme: 'dark',
    themeVariables: {
      primaryColor: '#3b82f6',
      primaryTextColor: '#e4e4e7',
      primaryBorderColor: '#3b82f6',
      lineColor: '#71717a',
      secondaryColor: '#27272a',
      tertiaryColor: '#18181b',
      background: '#1a1b26',
      mainBkg: '#27272a',
      nodeBorder: '#3b82f6',
      clusterBkg: '#18181b',
      clusterBorder: '#3b82f6',
      titleColor: '#e4e4e7',
      edgeLabelBackground: '#27272a',
    },
    flowchart: {
      curve: 'basis',
      padding: 20,
    },
  });

  // Render mermaid diagrams
  document.addEventListener('DOMContentLoaded', async () => {
    const codeBlocks = document.querySelectorAll('pre[data-language="mermaid"]');

    for (const pre of codeBlocks) {
      const codeElement = pre.querySelector('code');
      if (!codeElement) continue;

      const code = codeElement.textContent || '';
      const container = document.createElement('div');
      container.className = 'mermaid';

      try {
        const { svg } = await mermaid.render(`mermaid-${Math.random().toString(36).slice(2)}`, code);
        container.innerHTML = svg;
        pre.replaceWith(container);
      } catch (e) {
        console.error('Mermaid render error:', e);
      }
    }
  });
</script>
