---
import BaseLayout from '../layouts/BaseLayout.astro';
import { readFileSync, readdirSync, existsSync } from 'fs';
import { join, basename } from 'path';

// Proposal loading
interface Proposal {
  title: string;
  status: 'approved' | 'draft' | 'rejected';
  author?: string;
  created?: string;
  approved?: string;
  rejected?: string;
  summary?: string;
  filename: string;
  path: string;
}

function parseProposal(content: string, filename: string, dir: string, status: 'approved' | 'draft' | 'rejected'): Proposal {
  const lines = content.split('\n');

  // Extract title from first H1
  const titleMatch = lines[0]?.match(/^#\s+(?:Proposal:\s*)?(.+)/);
  const title = titleMatch ? titleMatch[1].trim() : filename.replace(/-proposal\.md$/, '').replace(/-/g, ' ');

  // Extract metadata from **Key:** Value format
  const getField = (key: string): string | undefined => {
    const regex = new RegExp(`\\*\\*${key}:\\*\\*\\s*(.+)`, 'i');
    for (const line of lines.slice(0, 20)) {
      const match = line.match(regex);
      if (match) return match[1].trim();
    }
    return undefined;
  };

  // Extract summary - first paragraph after "## Summary"
  let summary: string | undefined;
  const summaryIdx = lines.findIndex(l => l.match(/^##\s+Summary/i));
  if (summaryIdx !== -1) {
    const summaryLines: string[] = [];
    for (let i = summaryIdx + 1; i < lines.length; i++) {
      const line = lines[i];
      if (line.startsWith('#') || line.startsWith('---')) break;
      if (line.trim()) summaryLines.push(line.trim());
      else if (summaryLines.length > 0) break;
    }
    summary = summaryLines.join(' ').slice(0, 200);
    if (summary.length === 200) summary += '...';
  }

  return {
    title,
    status,
    author: getField('Author'),
    created: getField('Created'),
    approved: getField('Approved'),
    rejected: getField('Rejected'),
    summary,
    filename,
    path: `proposals/${dir}/${filename}`,
  };
}

function loadProposals(dir: string, status: 'approved' | 'draft' | 'rejected'): Proposal[] {
  const proposalsDir = join(process.cwd(), '..', 'docs', 'ori_lang', 'proposals', dir);
  if (!existsSync(proposalsDir)) return [];

  const files = readdirSync(proposalsDir).filter(f => f.endsWith('.md'));
  return files.map(file => {
    const content = readFileSync(join(proposalsDir, file), 'utf-8');
    return parseProposal(content, file, dir, status);
  }).sort((a, b) => {
    // Sort by created date descending, then by title
    if (a.created && b.created) {
      return b.created.localeCompare(a.created);
    }
    return a.title.localeCompare(b.title);
  });
}

const approvedProposals = loadProposals('approved', 'approved');
const draftProposals = loadProposals('drafts', 'draft');
const rejectedProposals = loadProposals('rejected', 'rejected');

// Format date to US standard (e.g., "January 27, 2026")
function formatDate(dateStr: string | undefined): string | undefined {
  if (!dateStr) return undefined;
  const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!match) return dateStr;
  const [, year, month, day] = match;
  const months = ['January', 'February', 'March', 'April', 'May', 'June',
                  'July', 'August', 'September', 'October', 'November', 'December'];
  const monthName = months[parseInt(month, 10) - 1];
  return `${monthName} ${parseInt(day, 10)}, ${year}`;
}

interface Task {
  name: string;
  done: boolean;
}

interface Section {
  name: string;
  tasks: Task[];
}

interface Phase {
  num: number | string;
  name: string;
  status: "complete" | "partial" | "not-started";
  note?: string;
  goal: string;
  spec?: string;
  sections: Section[];
}

interface Tier {
  id: number;
  name: string;
  status: string;
  description: string;
  phases: Phase[];
  milestone: string;
  milestoneStatus: string;
  exitCriteria: string;
}

const tiers: Tier[] = [
  {
    id: 1,
    name: "Foundation",
    status: "complete",
    description: "Core type system and language fundamentals",
    phases: [
      {
        num: 1,
        name: "Type System Foundation",
        status: "complete",
        goal: "Fix type checking to properly use type annotations",
        spec: "spec/06-types.md, spec/07-properties-of-types.md",
        sections: [
          { name: "Primitive Types", tasks: [
            { name: "int, float, bool, str types", done: true },
            { name: "char, byte types", done: true },
            { name: "void, Never types", done: true },
          ]},
          { name: "Parameter Type Annotations", tasks: [
            { name: "type_id_to_type() helper", done: true },
            { name: "Use Param.ty in infer_function_signature()", done: true },
            { name: "Handle declared return types", done: true },
          ]},
          { name: "Lambda Type Annotations", tasks: [
            { name: "Typed lambda parameters", done: true },
            { name: "Explicit return type", done: true },
          ]},
          { name: "Let Binding Types", tasks: [
            { name: "Type annotation in let bindings", done: true },
          ]},
        ],
      },
      {
        num: 2,
        name: "Type Inference",
        status: "complete",
        goal: "Implement Hindley-Milner style type inference",
        spec: "spec/06-types.md",
        sections: [
          { name: "Unification", tasks: [
            { name: "Type variable creation", done: true },
            { name: "Unification algorithm", done: true },
            { name: "Occurs check", done: true },
          ]},
          { name: "Constraint Generation", tasks: [
            { name: "Expression constraints", done: true },
            { name: "Function call constraints", done: true },
            { name: "Pattern constraints", done: true },
          ]},
          { name: "Generalization", tasks: [
            { name: "Let polymorphism", done: true },
            { name: "Function generalization", done: true },
          ]},
        ],
      },
      {
        num: 3,
        name: "Traits",
        status: "complete",
        goal: "Implement trait system with bounds and implementations",
        spec: "spec/08-declarations.md",
        sections: [
          { name: "Trait Definitions", tasks: [
            { name: "Trait declaration parsing", done: true },
            { name: "Required methods", done: true },
            { name: "Default implementations", done: true },
            { name: "Associated types", done: true },
          ]},
          { name: "Trait Implementations", tasks: [
            { name: "impl Trait for Type", done: true },
            { name: "Generic implementations", done: true },
            { name: "Coherence checking", done: true },
          ]},
          { name: "Trait Bounds", tasks: [
            { name: "Single bounds", done: true },
            { name: "Multiple bounds (T: A + B)", done: true },
            { name: "Where clauses", done: true },
          ]},
          { name: "Derive Macros", tasks: [
            { name: "Eq derive", done: true },
            { name: "Clone derive", done: true },
            { name: "Default derive", done: true },
          ]},
        ],
      },
      {
        num: 4,
        name: "Modules",
        status: "complete",
        note: "Module alias, re-export, qualified access all working",
        goal: "Implement module system with imports and visibility",
        spec: "spec/12-modules.md",
        sections: [
          { name: "Basic Imports", tasks: [
            { name: "Relative imports (./path)", done: true },
            { name: "Package imports (std.math)", done: true },
            { name: "Named imports { a, b }", done: true },
          ]},
          { name: "Visibility", tasks: [
            { name: "pub modifier", done: true },
            { name: "Private by default", done: true },
            { name: "Private access (::prefix)", done: true },
          ]},
          { name: "Advanced Features", tasks: [
            { name: "Module aliases (as)", done: true },
            { name: "Re-exports (pub use)", done: true },
            { name: "Qualified access - runtime", done: true },
            { name: "Qualified access - type checker", done: true },
          ]},
        ],
      },
      {
        num: 5,
        name: "Type Declarations",
        status: "complete",
        note: "Structs, sum types (multi-field variants), newtypes all work",
        goal: "User-defined types: structs, enums, newtypes",
        spec: "spec/06-types.md, spec/08-declarations.md",
        sections: [
          { name: "Struct Types", tasks: [
            { name: "Struct declaration", done: true },
            { name: "Field access", done: true },
            { name: "Struct literals", done: true },
            { name: "Generic structs", done: true },
          ]},
          { name: "Sum Types", tasks: [
            { name: "Enum declaration", done: true },
            { name: "Variant constructors", done: true },
            { name: "Pattern matching", done: true },
            { name: "Multi-field variants (e.g. Click(x, y))", done: true },
          ]},
          { name: "Newtypes", tasks: [
            { name: "Newtype declaration", done: true },
            { name: "Nominal type identity", done: true },
            { name: "Constructor pattern", done: true },
            { name: "unwrap() method", done: true },
          ]},
          { name: "Destructuring", tasks: [
            { name: "Struct destructuring", done: true },
            { name: "Tuple destructuring", done: true },
            { name: "List destructuring", done: true },
            { name: "Nested destructuring", done: true },
          ]},
        ],
      },
    ],
    milestone: "M1: Bootstrapped",
    milestoneStatus: "complete",
    exitCriteria: "Can write programs using traits and modules",
  },
  {
    id: 2,
    name: "Capabilities & Stdlib",
    status: "partial",
    description: "Effect tracking and standard library",
    phases: [
      {
        num: 6,
        name: "Capabilities",
        status: "complete",
        note: "27/27 tests pass",
        goal: "Implement capability system for effect tracking",
        spec: "spec/14-capabilities.md",
        sections: [
          { name: "Capability Declaration", tasks: [
            { name: "uses clause parsing", done: true },
            { name: "Capability trait definitions", done: true },
            { name: "Standard capabilities (Http, FileSystem, etc.)", done: true },
          ]},
          { name: "Capability Propagation", tasks: [
            { name: "Automatic propagation to callers", done: true },
            { name: "E2014 missing capability errors", done: true },
          ]},
          { name: "Capability Providing", tasks: [
            { name: "with...in expression", done: true },
            { name: "Mock implementations for testing", done: true },
          ]},
          { name: "Async Capability", tasks: [
            { name: "Async marker capability", done: true },
            { name: "Integration with parallel pattern", done: true },
          ]},
        ],
      },
      {
        num: "7A",
        name: "Core Built-ins",
        status: "partial",
        note: "Type conversions, assertions, I/O, developer functions",
        goal: "Core built-in functions and type conversions",
        spec: "library/std/",
        sections: [
          { name: "Type Conversions (as/as? syntax)", tasks: [
            { name: "As<T> trait for infallible conversions", done: false },
            { name: "TryAs<T> trait for fallible conversions", done: false },
            { name: "x as T / x as? T syntax", done: false },
            { name: "Float truncation methods", done: false },
          ]},
          { name: "Assertions", tasks: [
            { name: "assert, assert_eq, assert_ne", done: true },
            { name: "assert_some, assert_none", done: true },
            { name: "assert_ok, assert_err", done: true },
            { name: "assert_panics, assert_panics_with", done: true },
          ]},
          { name: "I/O Functions", tasks: [
            { name: "print function", done: true },
            { name: "panic function", done: true },
          ]},
          { name: "Developer Functions", tasks: [
            { name: "todo() placeholder function", done: false },
            { name: "unreachable() assertion", done: false },
            { name: "dbg() debug helper", done: false },
          ]},
          { name: "Float NaN Handling", tasks: [
            { name: "NaN comparisons panic", done: false },
          ]},
        ],
      },
      {
        num: "7B",
        name: "Option & Result",
        status: "partial",
        note: "Option/Result methods",
        goal: "Methods for Option<T> and Result<T, E> types",
        spec: "library/std/",
        sections: [
          { name: "Option Methods", tasks: [
            { name: "map, and_then, filter", done: true },
            { name: "unwrap_or, ok_or", done: true },
            { name: "is_some, is_none", done: true },
          ]},
          { name: "Result Methods", tasks: [
            { name: "map, map_err, and_then", done: true },
            { name: "unwrap_or, ok, err", done: true },
            { name: "is_ok, is_err", done: true },
            { name: "context for error traces", done: false },
          ]},
        ],
      },
      {
        num: "7C",
        name: "Collections & Iteration",
        status: "partial",
        note: "Collection methods done (map, filter, fold, find, collect)",
        goal: "Collection methods and iterator traits",
        spec: "library/std/",
        sections: [
          { name: "Collection Methods", tasks: [
            { name: "List: map, filter, fold, find", done: true },
            { name: "List: any, all", done: true },
            { name: "Range: collect, map, filter, fold", done: true },
            { name: "Map: len, is_empty", done: true },
          ]},
          { name: "Iterator Traits", tasks: [
            { name: "Iterator trait with next()", done: false },
            { name: "DoubleEndedIterator trait", done: false },
            { name: "Iterable trait with iter()", done: false },
            { name: "Collect trait for collection building", done: false },
          ]},
          { name: "Debug Trait", tasks: [
            { name: "Debug trait definition", done: false },
            { name: "#derive(Debug) support", done: false },
            { name: "Standard Debug implementations", done: false },
          ]},
        ],
      },
      {
        num: "7D",
        name: "Stdlib Modules",
        status: "partial",
        note: "retry, validate pending; time/json/fs/crypto proposals approved",
        goal: "Standard library modules: validate, resilience, math, time, json, fs, crypto",
        spec: "library/std/",
        sections: [
          { name: "std.validate", tasks: [
            { name: "validate function", done: false },
            { name: "Validation rules", done: false },
          ]},
          { name: "std.resilience", tasks: [
            { name: "retry function", done: false },
            { name: "Backoff strategies", done: false },
          ]},
          { name: "std.math", tasks: [
            { name: "Overflow handling functions", done: false },
            { name: "saturating_*, wrapping_*, checked_*", done: false },
            { name: "int.min, int.max, byte.min, byte.max constants", done: false },
          ]},
          { name: "std.time", tasks: [
            { name: "Instant, DateTime, Timezone types", done: false },
            { name: "Duration extension methods", done: false },
            { name: "Clock capability", done: false },
            { name: "MockClock for testing", done: false },
          ]},
          { name: "std.json", tasks: [
            { name: "JsonValue type, parse/stringify", done: false },
            { name: "#derive(Json) support", done: false },
            { name: "Streaming JsonParser", done: false },
          ]},
          { name: "std.fs", tasks: [
            { name: "Path, FileInfo types", done: false },
            { name: "read, write, list_dir, walk_dir functions", done: false },
            { name: "FileSystem capability", done: false },
            { name: "Glob pattern matching", done: false },
            { name: "Temp file utilities", done: false },
          ]},
          { name: "std.crypto", tasks: [
            { name: "Type-safe key pairs (SigningKeyPair, etc.)", done: false },
            { name: "Password hashing (Argon2id)", done: false },
            { name: "Symmetric encryption (XSalsa20-Poly1305)", done: false },
            { name: "Digital signatures (Ed25519/RSA)", done: false },
            { name: "Secure random (CSPRNG)", done: false },
          ]},
        ],
      },
    ],
    milestone: "M2: Capabilities & Stdlib",
    milestoneStatus: "partial",
    exitCriteria: "Capabilities working, stdlib available",
  },
  {
    id: 3,
    name: "Core Patterns",
    status: "in-progress",
    description: "Pattern evaluation and control flow",
    phases: [
      {
        num: 8,
        name: "Pattern Evaluation",
        status: "partial",
        note: "Data transformation done; retry pattern pending",
        goal: "Implement compiler patterns: run, try, recurse, parallel, etc.",
        spec: "spec/09-expressions.md",
        sections: [
          { name: "Sequential Patterns", tasks: [
            { name: "run(...) pattern", done: true },
            { name: "try(...) with ? propagation", done: true },
          ]},
          { name: "Recursion", tasks: [
            { name: "recurse(...) pattern", done: true },
            { name: "self() recursive call", done: true },
            { name: "Memoization (memo: true)", done: false },
          ]},
          { name: "Concurrency", tasks: [
            { name: "parallel(...) pattern", done: true },
            { name: "spawn(...) fire-and-forget", done: true },
            { name: "timeout(...) pattern", done: false },
          ]},
          { name: "Resources", tasks: [
            { name: "cache(...) pattern", done: false },
            { name: "with(...) resource management", done: true },
          ]},
        ],
      },
      {
        num: 9,
        name: "Match Expressions",
        status: "partial",
        note: "Guards and exhaustiveness pending",
        goal: "Pattern matching with exhaustiveness checking",
        spec: "spec/10-patterns.md",
        sections: [
          { name: "Basic Patterns", tasks: [
            { name: "Literal patterns", done: true },
            { name: "Variable binding", done: true },
            { name: "Wildcard (_)", done: true },
            { name: "Variant patterns", done: true },
          ]},
          { name: "Advanced Patterns", tasks: [
            { name: "Struct patterns", done: true },
            { name: "List patterns with rest (..)", done: true },
            { name: "Or patterns (A | B)", done: true },
            { name: "At patterns (x @ pat)", done: false },
          ]},
          { name: "Guards & Exhaustiveness", tasks: [
            { name: "Guard expressions", done: false },
            { name: "Exhaustiveness checking", done: false },
            { name: "Usefulness analysis", done: false },
          ]},
        ],
      },
      {
        num: 10,
        name: "Control Flow",
        status: "partial",
        note: "Loops and break/continue work; labeled loops pending",
        goal: "Loops, break, continue, labeled blocks",
        spec: "spec/19-control-flow.md",
        sections: [
          { name: "Loops", tasks: [
            { name: "loop(...) expression", done: true },
            { name: "for...do imperative", done: true },
            { name: "for...yield collection", done: true },
          ]},
          { name: "Control", tasks: [
            { name: "break expression", done: true },
            { name: "break with value", done: true },
            { name: "continue expression", done: true },
          ]},
          { name: "Labels", tasks: [
            { name: "Labeled loops (loop:name)", done: false },
            { name: "Labeled break/continue", done: false },
          ]},
        ],
      },
    ],
    milestone: "M3: Core Patterns",
    milestoneStatus: "partial",
    exitCriteria: "All pattern and control flow constructs working",
  },
  {
    id: 4,
    name: "FFI & Interop",
    status: "planned",
    description: "Foreign code integration",
    phases: [
      {
        num: 11,
        name: "FFI",
        status: "not-started",
        note: "Proposal approved - unified native/WASM FFI",
        goal: "Call C functions and JavaScript APIs",
        spec: "spec/16-ffi.md",
        sections: [
          { name: "Native FFI (C ABI)", tasks: [
            { name: "extern \"c\" from \"lib\" syntax", done: false },
            { name: "C type aliases (c_int, c_size, etc.)", done: false },
            { name: "CPtr opaque pointer type", done: false },
            { name: "#repr(\"c\") struct layout", done: false },
          ]},
          { name: "WASM FFI (JavaScript)", tasks: [
            { name: "extern \"js\" syntax", done: false },
            { name: "JsValue handle type", done: false },
            { name: "JsPromise<T> implicit resolution", done: false },
          ]},
          { name: "Safety", tasks: [
            { name: "FFI capability requirement", done: false },
            { name: "unsafe { } blocks", done: false },
            { name: "compile_error() built-in", done: false },
          ]},
        ],
      },
      {
        num: 12,
        name: "Variadic Functions",
        status: "not-started",
        goal: "Support C-style variadic functions",
        spec: "Design pending",
        sections: [
          { name: "C Variadics", tasks: [
            { name: "Call variadic C functions", done: false },
            { name: "va_list handling", done: false },
          ]},
          { name: "Ori Variadics (optional)", tasks: [
            { name: "Variadic function declaration", done: false },
            { name: "Type-safe variadics", done: false },
          ]},
        ],
      },
    ],
    milestone: "M4: FFI & Interop",
    milestoneStatus: "not-started",
    exitCriteria: "Can call C libraries",
  },
  {
    id: 5,
    name: "Language Completion",
    status: "planned",
    description: "Platform support and testing framework",
    phases: [
      {
        num: 13,
        name: "Conditional Compilation",
        status: "not-started",
        note: "Proposal approved - #target and #cfg attributes",
        goal: "Platform and feature-based compilation",
        spec: "spec/08-declarations.md",
        sections: [
          { name: "Target Attributes", tasks: [
            { name: "#target(os:) attribute", done: false },
            { name: "#target(arch:) attribute", done: false },
            { name: "#target(family:) attribute", done: false },
            { name: "File-level #!target(...)", done: false },
          ]},
          { name: "Config Attributes", tasks: [
            { name: "#cfg(debug) / #cfg(release)", done: false },
            { name: "#cfg(feature:) attribute", done: false },
            { name: "Negation: not_os, not_arch, not_feature", done: false },
          ]},
          { name: "Compile-time Constants", tasks: [
            { name: "$target_os, $target_arch constants", done: false },
            { name: "$target_family constant", done: false },
            { name: "$debug, $release constants", done: false },
          ]},
        ],
      },
      {
        num: 14,
        name: "Testing Framework",
        status: "not-started",
        note: "Gap analysis complete; incremental/execution models approved",
        goal: "Mandatory testing with dependency tracking",
        spec: "spec/13-testing.md",
        sections: [
          { name: "Test Declaration", tasks: [
            { name: "@test annotation", done: false },
            { name: "Attached tests (tests @target)", done: false },
            { name: "Floating tests (tests _)", done: false },
          ]},
          { name: "Test Execution", tasks: [
            { name: "Parallel test runner", done: false },
            { name: "Dependency-aware execution", done: false },
            { name: "Content-based change detection", done: false },
            { name: "Test cache in .ori/cache/test/", done: false },
          ]},
          { name: "Special Tests", tasks: [
            { name: "#skip annotation", done: false },
            { name: "#compile_fail tests", done: false },
            { name: "#fail expected failure", done: false },
          ]},
          { name: "CLI Integration", tasks: [
            { name: "ori test command", done: false },
            { name: "ori check --strict for CI", done: false },
            { name: "ori check --clean (exclude floating)", done: false },
          ]},
        ],
      },
      {
        num: "15A",
        name: "Attributes & Comments",
        status: "not-started",
        note: "Simplified attributes, function_seq/exp, inline comments",
        goal: "Attribute syntax changes and comment rules",
        spec: "docs/ori_lang/proposals/",
        sections: [
          { name: "Simplified Attribute Syntax", tasks: [
            { name: "#name(...) syntax (remove brackets)", done: false },
            { name: "Generalize attributes to all declarations", done: false },
            { name: "Attribute validation", done: false },
            { name: "Migration support (accept both syntaxes)", done: false },
          ]},
          { name: "function_seq vs function_exp", tasks: [
            { name: "Verify AST has separate types", done: false },
            { name: "Parser enforces named args for builtins", done: false },
          ]},
          { name: "Inline Comments Prohibition", tasks: [
            { name: "Lexer rejects inline comments", done: false },
            { name: "Clear error message", done: false },
          ]},
        ],
      },
      {
        num: "15B",
        name: "Function Syntax",
        status: "not-started",
        note: "Remove dot prefix, default params, function clauses, positional lambdas",
        goal: "Function declaration and call syntax changes",
        spec: "docs/ori_lang/proposals/",
        sections: [
          { name: "Remove Dot Prefix", tasks: [
            { name: "Update all built-ins to named args", done: false },
            { name: "print(msg:), len(collection:), assert(condition:)", done: false },
          ]},
          { name: "Default Parameters", tasks: [
            { name: "param: Type = default_expr syntax", done: false },
            { name: "Call-time evaluation", done: false },
            { name: "Works with named args", done: false },
          ]},
          { name: "Function Clauses", tasks: [
            { name: "Pattern matching in parameters", done: false },
            { name: "if guards", done: false },
            { name: "Exhaustiveness checking", done: false },
          ]},
          { name: "Positional Lambdas", tasks: [
            { name: "items.map(x -> x * 2) syntax", done: false },
            { name: "Lambda literal detection", done: false },
            { name: "self excluded from param count", done: false },
          ]},
        ],
      },
      {
        num: "15C",
        name: "Literals & Operators",
        status: "not-started",
        note: "String interpolation, spread operator, range step",
        goal: "Literal syntax and operator additions",
        spec: "docs/ori_lang/proposals/",
        sections: [
          { name: "String Interpolation", tasks: [
            { name: "Template strings with backticks", done: false },
            { name: "{expr} interpolation", done: false },
            { name: "Format specifiers {value:.2}", done: false },
            { name: "Formattable trait", done: false },
          ]},
          { name: "Spread Operator", tasks: [
            { name: "[...a, ...b] list spread", done: false },
            { name: "{...a, ...b} map spread", done: false },
            { name: "T { ...s, x: v } struct spread", done: false },
          ]},
          { name: "Range with Step", tasks: [
            { name: "0..10 by 2 syntax", done: false },
            { name: "Integer-only restriction", done: false },
            { name: "Zero step panics", done: false },
          ]},
        ],
      },
      {
        num: "15D",
        name: "Bindings & Types",
        status: "not-started",
        note: "Pre/post checks, as conversion, $ bindings, remove dyn",
        goal: "Binding syntax and type system changes",
        spec: "docs/ori_lang/proposals/",
        sections: [
          { name: "Pre/Post Checks", tasks: [
            { name: "pre_check: for run pattern", done: false },
            { name: "post_check: for run pattern", done: false },
            { name: "Custom messages with | syntax", done: false },
          ]},
          { name: "as Conversion Syntax", tasks: [
            { name: "x as T / x as? T parsing", done: false },
            { name: "As<T>, TryAs<T> traits", done: false },
            { name: "Remove int()/float()/str()/byte()", done: false },
          ]},
          { name: "Simplified Bindings", tasks: [
            { name: "let x mutable, let $x immutable", done: false },
            { name: "Remove mut keyword", done: false },
            { name: "Module-level bindings require $", done: false },
          ]},
          { name: "Remove dyn Keyword", tasks: [
            { name: "Trait names as trait objects directly", done: false },
          ]},
        ],
      },
    ],
    milestone: "M5: Language Complete",
    milestoneStatus: "not-started",
    exitCriteria: "All core language features complete (Phases 1-15)",
  },
  {
    id: 6,
    name: "Async & Concurrency",
    status: "future",
    description: "Async runtime and concurrent programming",
    phases: [
      {
        num: 16,
        name: "Async Support",
        status: "not-started",
        goal: "Async runtime with capability-based effects",
        spec: "spec/14-capabilities.md",
        sections: [
          { name: "Async Runtime", tasks: [
            { name: "Event loop", done: false },
            { name: "Task scheduler", done: false },
            { name: "Non-blocking I/O", done: false },
          ]},
          { name: "Async Capability", tasks: [
            { name: "uses Async declaration", done: false },
            { name: "Suspension points", done: false },
          ]},
        ],
      },
      {
        num: 17,
        name: "Concurrency Extended",
        status: "not-started",
        note: "Sendable, channels, nursery, cancellation proposals approved",
        goal: "Advanced concurrency primitives",
        spec: "spec/14-capabilities.md",
        sections: [
          { name: "Sendable Trait", tasks: [
            { name: "Auto-implemented marker trait", done: false },
            { name: "Closure Sendability via capture analysis", done: false },
            { name: "Channel types (Producer, Consumer) ARE Sendable", done: false },
          ]},
          { name: "Role-Based Channels", tasks: [
            { name: "Producer<T>, Consumer<T> types", done: false },
            { name: "CloneableProducer, CloneableConsumer", done: false },
            { name: "channel(), channel_in(), channel_out(), channel_all()", done: false },
          ]},
          { name: "Structured Concurrency", tasks: [
            { name: "nursery pattern with body callback", done: false },
            { name: "NurseryErrorMode (FailFast, CancelRemaining, CollectAll)", done: false },
            { name: "Guaranteed task completion", done: false },
          ]},
          { name: "Cancellation", tasks: [
            { name: "Cooperative cancellation model", done: false },
            { name: "CancellationError, CancellationReason types", done: false },
            { name: "is_cancelled() built-in function", done: false },
            { name: "Automatic loop iteration checking", done: false },
          ]},
          { name: "Parallel Execution", tasks: [
            { name: "parallel() max_concurrent, timeout params", done: false },
            { name: "Results in original task order", done: false },
            { name: "Per-task ResourceExhausted errors", done: false },
          ]},
        ],
      },
    ],
    milestone: "M6: Production Async",
    milestoneStatus: "not-started",
    exitCriteria: "Can write server with graceful shutdown",
  },
  {
    id: 7,
    name: "Advanced Type System",
    status: "future",
    description: "Power-user type features",
    phases: [
      {
        num: 18,
        name: "Const Generics",
        status: "not-started",
        note: "Termination/fixed-capacity list proposals approved",
        goal: "Compile-time constant type parameters",
        spec: "spec/06-types.md",
        sections: [
          { name: "Const Parameters", tasks: [
            { name: "$N: int syntax for const params", done: false },
            { name: "Const evaluation with termination limits", done: false },
            { name: "where N > 0 const bounds", done: false },
          ]},
          { name: "Const Evaluation", tasks: [
            { name: "Resource limits (1M steps, 1000 depth, 100MB, 10s)", done: false },
            { name: "Partial evaluation", done: false },
            { name: "Caching by function + args hash", done: false },
            { name: "Local mutation in const functions", done: false },
          ]},
          { name: "Fixed-Capacity Lists", tasks: [
            { name: "[T, max N] type syntax", done: false },
            { name: "Subtyping: [T, max N] <: [T]", done: false },
            { name: "capacity(), is_full(), remaining() methods", done: false },
            { name: "to_fixed<$N>(), try_to_fixed<$N>() conversions", done: false },
          ]},
        ],
      },
      {
        num: 19,
        name: "Existential Types",
        status: "not-started",
        note: "impl Trait",
        goal: "impl Trait return types and parameters",
        spec: "Design pending",
        sections: [
          { name: "Return Position", tasks: [
            { name: "-> impl Trait syntax", done: false },
            { name: "Type inference for impl Trait", done: false },
          ]},
          { name: "Argument Position", tasks: [
            { name: "(x: impl Trait) syntax", done: false },
            { name: "Universal quantification", done: false },
          ]},
        ],
      },
    ],
    milestone: "M7: Advanced Types",
    milestoneStatus: "not-started",
    exitCriteria: "Can write matrix library with compile-time checking",
  },
  {
    id: 8,
    name: "Advanced Features",
    status: "future",
    description: "Reflection, native compilation, and tooling",
    phases: [
      {
        num: 20,
        name: "Reflection",
        status: "not-started",
        goal: "Runtime type introspection",
        spec: "Design pending",
        sections: [
          { name: "Type Info", tasks: [
            { name: "TypeInfo struct", done: false },
            { name: "Field introspection", done: false },
            { name: "Method introspection", done: false },
          ]},
          { name: "Dynamic Dispatch", tasks: [
            { name: "dyn Trait objects", done: false },
            { name: "Runtime method lookup", done: false },
          ]},
        ],
      },
      {
        num: "21A",
        name: "LLVM Backend",
        status: "partial",
        note: "JIT working; 977/996 tests pass (19 skipped)",
        goal: "Compile to native code via LLVM JIT",
        spec: "Implementation-specific",
        sections: [
          { name: "LLVM Setup", tasks: [
            { name: "LLVM 17+ integration", done: true },
            { name: "inkwell/llvm-sys bindings", done: true },
            { name: "Target configuration (JIT)", done: true },
          ]},
          { name: "IR Generation", tasks: [
            { name: "Type lowering (Ori -> LLVM)", done: true },
            { name: "Expression codegen", done: true },
            { name: "Function codegen", done: true },
            { name: "Control flow graphs", done: true },
            { name: "Destructuring support", done: true },
          ]},
          { name: "JIT Execution", tasks: [
            { name: "JIT compilation", done: true },
            { name: "Runtime support functions", done: true },
            { name: "Generic function support", done: true },
          ]},
        ],
      },
      {
        num: "21B",
        name: "AOT Compilation",
        status: "not-started",
        note: "Object file generation, optimization, linking",
        goal: "Ahead-of-time compilation to native executables",
        spec: "Implementation-specific",
        sections: [
          { name: "Optimization", tasks: [
            { name: "O0-O3 optimization levels", done: false },
            { name: "Debug info (DWARF)", done: false },
          ]},
          { name: "Output", tasks: [
            { name: "Object file emission", done: false },
            { name: "Executable linking", done: false },
          ]},
          { name: "Runtime", tasks: [
            { name: "ARC memory management", done: false },
            { name: "FFI runtime support", done: false },
          ]},
        ],
      },
      {
        num: 22,
        name: "Tooling",
        status: "partial",
        note: "Formatter CLI complete (440 tests); LSP/WASM pending",
        goal: "Developer tooling ecosystem",
        spec: "Implementation-specific",
        sections: [
          { name: "Formatter", tasks: [
            { name: "Width calculation engine", done: true },
            { name: "ori fmt command", done: true },
            { name: "ori fmt --check for CI", done: true },
            { name: "Zero-config formatting", done: true },
          ]},
          { name: "Language Server", tasks: [
            { name: "LSP implementation", done: false },
            { name: "Go to definition", done: false },
            { name: "Find references", done: false },
            { name: "Hover info", done: false },
            { name: "Completions", done: false },
          ]},
          { name: "REPL", tasks: [
            { name: "Interactive shell", done: false },
            { name: "Expression evaluation", done: false },
            { name: "History and completion", done: false },
          ]},
          { name: "Test Runner", tasks: [
            { name: "ori test command", done: true },
            { name: "File and directory filtering", done: true },
            { name: "Parallel execution", done: true },
            { name: "Test output formatting", done: true },
            { name: "Coverage report generation", done: true },
          ]},
          { name: "Causality Tracking", tasks: [
            { name: "ori impact @target (blast radius)", done: false },
            { name: "ori why @target (causality chain)", done: false },
            { name: "--verbose, --diff, --graph output modes", done: false },
          ]},
          { name: "Structured Diagnostics", tasks: [
            { name: "JSON output mode (--json)", done: false },
            { name: "Auto-fix (--fix, --fix=all)", done: false },
            { name: "Applicability levels", done: false },
            { name: "Rust-style source snippets", done: false },
          ]},
        ],
      },
    ],
    milestone: "M8: Full Featured",
    milestoneStatus: "not-started",
    exitCriteria: "Full IDE support, generic serialization, native binaries",
  },
];

const statusLabels: Record<string, string> = {
  "complete": "Complete",
  "partial": "In Progress",
  "in-progress": "In Progress",
  "not-started": "Not Started",
  "planned": "Planned",
  "future": "Future",
  "near-complete": "Near Complete",
};

// Extract phases by status for the collapsible sections
const completedPhases: Phase[] = [];
const inProgressPhases: Phase[] = [];
const plannedPhases: Phase[] = [];

for (const tier of tiers) {
  for (const phase of tier.phases) {
    if (phase.status === "complete") {
      completedPhases.push(phase);
    } else if (phase.status === "partial") {
      inProgressPhases.push(phase);
    } else {
      plannedPhases.push(phase);
    }
  }
}

const statusColors: Record<string, string> = {
  "complete": "success",
  "partial": "warning",
  "in-progress": "warning",
  "not-started": "muted",
  "planned": "muted",
  "future": "muted",
  "near-complete": "warning",
};

function countTasks(sections: Section[]): { done: number; total: number } {
  let done = 0;
  let total = 0;
  for (const section of sections) {
    for (const task of section.tasks) {
      total++;
      if (task.done) done++;
    }
  }
  return { done, total };
}
---

<BaseLayout
  title="Roadmap — Ori"
  description="Ori compiler roadmap: 22 phases across 8 tiers. Track progress on type system, traits, capabilities, async, FFI, LLVM backend, and tooling."
  keywords="Ori roadmap, compiler development, language features, type system, async, FFI, LLVM, tooling"
>
  <main class="roadmap-page">
    <section class="roadmap-hero">
      <h1>Compiler Roadmap</h1>
      <p class="roadmap-subtitle">
        29 phases across 8 tiers. Click any phase to view details.
      </p>
      <div class="stats">
        <div class="stat">
          <span class="stat-value">6</span>
          <span class="stat-label">Completed</span>
        </div>
        <div class="stat">
          <span class="stat-value">9</span>
          <span class="stat-label">In Progress</span>
        </div>
        <div class="stat">
          <span class="stat-value">14</span>
          <span class="stat-label">Planned</span>
        </div>
      </div>
    </section>

    <section class="status-section in-progress-section">
      <details open>
        <summary class="status-header in-progress">
          <span class="status-icon">◐</span>
          <h2>In Progress</h2>
          <span class="status-count">{inProgressPhases.length} phases</span>
          <span class="expand-icon"></span>
        </summary>
        <div class="status-phases">
          {inProgressPhases.map((phase) => {
            const { done, total } = countTasks(phase.sections);
            return (
              <button
                class="phase-card partial"
                data-phase={JSON.stringify(phase)}
                type="button"
              >
                <div class="phase-header">
                  <span class="phase-num">Phase {phase.num}</span>
                  <span class="phase-status warning">In Progress</span>
                </div>
                <h3>{phase.name}</h3>
                <p class="phase-note">{phase.note || phase.goal}</p>
                <div class="phase-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style={`width: ${total > 0 ? (done / total) * 100 : 0}%`}></div>
                  </div>
                  <span class="progress-text">{done}/{total} tasks</span>
                </div>
              </button>
            );
          })}
        </div>
      </details>
    </section>

    <section class="status-section planned-section">
      <details open>
        <summary class="status-header planned">
          <span class="status-icon">○</span>
          <h2>Planned</h2>
          <span class="status-count">{plannedPhases.length} phases</span>
          <span class="expand-icon"></span>
        </summary>
        <div class="status-phases">
          {plannedPhases.map((phase) => {
            const { done, total } = countTasks(phase.sections);
            return (
              <button
                class="phase-card not-started"
                data-phase={JSON.stringify(phase)}
                type="button"
              >
                <div class="phase-header">
                  <span class="phase-num">Phase {phase.num}</span>
                  <span class="phase-status muted">Not Started</span>
                </div>
                <h3>{phase.name}</h3>
                <p class="phase-note">{phase.note || phase.goal}</p>
                <div class="phase-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style={`width: ${total > 0 ? (done / total) * 100 : 0}%`}></div>
                  </div>
                  <span class="progress-text">{done}/{total} tasks</span>
                </div>
              </button>
            );
          })}
        </div>
      </details>
    </section>

    <section class="status-section completed-section">
      <details>
        <summary class="status-header completed">
          <span class="status-icon">✓</span>
          <h2>Completed</h2>
          <span class="status-count">{completedPhases.length} phases</span>
          <span class="expand-icon"></span>
        </summary>
        <div class="status-phases">
          {completedPhases.map((phase) => {
            const { done, total } = countTasks(phase.sections);
            return (
              <button
                class="phase-card complete"
                data-phase={JSON.stringify(phase)}
                type="button"
              >
                <div class="phase-header">
                  <span class="phase-num">Phase {phase.num}</span>
                  <span class="phase-status success">Complete</span>
                </div>
                <h3>{phase.name}</h3>
                <p class="phase-note">{phase.note || phase.goal}</p>
                <div class="phase-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style={`width: 100%`}></div>
                  </div>
                  <span class="progress-text">{done}/{total} tasks</span>
                </div>
              </button>
            );
          })}
        </div>
      </details>
    </section>

    <section class="dependency-graph">
      <h2>Dependency Graph</h2>
      <div class="graph-container">
        <pre class="graph">{`Phase 1 (Types) → Phase 2 (Inference) → Phase 3 (Traits) → Phase 4 (Modules)
    → Phase 5 (Type Decls) → Phase 6 (Capabilities) → Phase 7A-D (Stdlib)
    → Phase 8 (Patterns) → Phase 9 (Match) → Phase 10 (Control Flow)
    → Phase 11 (FFI) → Phase 12 (Variadics) → Phase 13 (Conditional)
    → Phase 14 (Testing) → Phase 15A-D (Syntax Proposals)

Branches:
  Phase 6 ──→ Phase 16 (Async) → Phase 17 (Concurrency)
  Phase 3 ──→ Phase 19 (Existential Types)
  Phase 2 ──→ Phase 18 (Const Generics)
  Phase 11 ──→ Phase 20 (Reflection)
  Core Complete (1-15) ──→ Phase 21A (LLVM) → Phase 21B (AOT) → Phase 22 (Tooling)`}</pre>
      </div>
    </section>

    <section class="test-results">
      <h2>Current Test Results</h2>
      <div class="results-grid">
        <div class="result-card">
          <span class="result-value">1286</span>
          <span class="result-label">Rust Unit Tests</span>
          <span class="result-status success">All Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">920</span>
          <span class="result-label">Ori Spec Tests</span>
          <span class="result-status success">Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">977</span>
          <span class="result-label">LLVM Backend Tests</span>
          <span class="result-status success">Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">204</span>
          <span class="result-label">LLVM Rust Tests</span>
          <span class="result-status success">All Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">440</span>
          <span class="result-label">Formatter Tests</span>
          <span class="result-status success">All Passing</span>
        </div>
      </div>
    </section>

    <section class="proposals-section">
      <h2>Language Proposals</h2>
      <p class="proposals-subtitle">
        Design decisions and rationale for language features. Proposals go through draft review before approval or rejection.
      </p>
      <div class="proposal-stats">
        <span class="proposal-stat approved">{approvedProposals.length} approved</span>
        <span class="proposal-stat draft">{draftProposals.length} drafts</span>
        <span class="proposal-stat rejected">{rejectedProposals.length} rejected</span>
      </div>

      <div class="proposal-categories">
        <section class="status-section draft-proposals-section">
          <details open>
            <summary class="status-header draft-header">
              <span class="status-icon">◐</span>
              <h3>Drafts</h3>
              <span class="status-count">{draftProposals.length} proposals</span>
              <span class="expand-icon"></span>
            </summary>
            <div class="proposal-grid">
              {draftProposals.map((proposal) => (
                <a
                  href={`https://github.com/upstat-io/ori-lang/blob/master/docs/ori_lang/${proposal.path}`}
                  class="proposal-card draft"
                  target="_blank"
                  rel="noopener"
                >
                  <h4>{proposal.title}</h4>
                  {proposal.summary && <p class="proposal-summary">{proposal.summary}</p>}
                  <div class="proposal-meta">
                    {proposal.author && <span class="proposal-author">{proposal.author}</span>}
                    {proposal.created && <span class="proposal-date">Created {formatDate(proposal.created)}</span>}
                  </div>
                </a>
              ))}
            </div>
          </details>
        </section>

        <section class="status-section approved-proposals-section">
          <details>
            <summary class="status-header approved-header">
              <span class="status-icon">✓</span>
              <h3>Approved</h3>
              <span class="status-count">{approvedProposals.length} proposals</span>
              <span class="expand-icon"></span>
            </summary>
            <div class="proposal-grid">
              {approvedProposals.map((proposal) => (
                <a
                  href={`https://github.com/upstat-io/ori-lang/blob/master/docs/ori_lang/${proposal.path}`}
                  class="proposal-card approved"
                  target="_blank"
                  rel="noopener"
                >
                  <h4>{proposal.title}</h4>
                  {proposal.summary && <p class="proposal-summary">{proposal.summary}</p>}
                  <div class="proposal-meta">
                    {proposal.author && <span class="proposal-author">{proposal.author}</span>}
                    {proposal.approved && <span class="proposal-date">Approved {formatDate(proposal.approved)}</span>}
                  </div>
                </a>
              ))}
            </div>
          </details>
        </section>

        <section class="status-section rejected-proposals-section">
          <details>
            <summary class="status-header rejected-header">
              <span class="status-icon">✕</span>
              <h3>Rejected</h3>
              <span class="status-count">{rejectedProposals.length} proposals</span>
              <span class="expand-icon"></span>
            </summary>
            <div class="proposal-grid">
              {rejectedProposals.map((proposal) => (
                <a
                  href={`https://github.com/upstat-io/ori-lang/blob/master/docs/ori_lang/${proposal.path}`}
                  class="proposal-card rejected"
                  target="_blank"
                  rel="noopener"
                >
                  <h4>{proposal.title}</h4>
                  {proposal.summary && <p class="proposal-summary">{proposal.summary}</p>}
                  <div class="proposal-meta">
                    {proposal.author && <span class="proposal-author">{proposal.author}</span>}
                    {proposal.rejected && <span class="proposal-date">Rejected {formatDate(proposal.rejected)}</span>}
                  </div>
                </a>
              ))}
            </div>
          </details>
        </section>
      </div>
    </section>

    <section class="roadmap-cta">
      <h2>Want to contribute?</h2>
      <p>The roadmap lives in <code>plans/roadmap/</code>. Each phase has detailed implementation tasks.</p>
      <div class="cta-buttons">
        <a href="https://github.com/upstat-io/ori-lang/tree/master/plans/roadmap" class="btn btn-primary" target="_blank" rel="noopener">View Full Roadmap</a>
        <a href="https://github.com/upstat-io/ori-lang" class="btn btn-secondary" target="_blank" rel="noopener">GitHub</a>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-overlay" id="phase-modal">
    <div class="modal-content">
      <button class="modal-close" type="button" aria-label="Close modal">&times;</button>
      <div class="modal-header">
        <div class="modal-phase-num" id="modal-phase-num"></div>
        <h2 class="modal-title" id="modal-title"></h2>
        <span class="modal-status" id="modal-status"></span>
      </div>
      <p class="modal-goal" id="modal-goal"></p>
      <div class="modal-sections" id="modal-sections"></div>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  (function() {
    const modal = document.getElementById('phase-modal');
    const modalClose = modal ? modal.querySelector('.modal-close') : null;
    const phaseCards = document.querySelectorAll('.phase-card');

    const statusLabels = {
      "complete": "Complete",
      "partial": "In Progress",
      "not-started": "Not Started"
    };

    const statusColors = {
      "complete": "success",
      "partial": "warning",
      "not-started": "muted"
    };

    function openModal(phaseData) {
      if (!phaseData || !modal) return;

      const phase = JSON.parse(phaseData);

      var phaseNum = document.getElementById('modal-phase-num');
      var title = document.getElementById('modal-title');
      var status = document.getElementById('modal-status');
      var goal = document.getElementById('modal-goal');
      var sections = document.getElementById('modal-sections');

      if (phaseNum) phaseNum.textContent = 'Phase ' + phase.num;
      if (title) title.textContent = phase.name;
      if (status) {
        status.textContent = statusLabels[phase.status] || phase.status;
        status.className = 'modal-status ' + (statusColors[phase.status] || 'muted');
      }
      if (goal) goal.textContent = phase.goal;

      if (sections) {
        var html = '';
        for (var i = 0; i < phase.sections.length; i++) {
          var section = phase.sections[i];
          html += '<div class="modal-section">';
          html += '<h4>' + section.name + '</h4>';
          html += '<ul class="task-list">';
          for (var j = 0; j < section.tasks.length; j++) {
            var task = section.tasks[j];
            var cls = task.done ? 'done' : 'pending';
            html += '<li class="' + cls + '">' + task.name + '</li>';
          }
          html += '</ul>';
          html += '</div>';
        }
        sections.innerHTML = html;
      }

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    for (var i = 0; i < phaseCards.length; i++) {
      (function(card) {
        card.addEventListener('click', function(e) {
          e.preventDefault();
          var phaseData = card.getAttribute('data-phase');
          openModal(phaseData);
        });
      })(phaseCards[i]);
    }

    if (modalClose) {
      modalClose.addEventListener('click', closeModal);
    }

    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
      });
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });
  })();
</script>

<style>
  .roadmap-page {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--space-8) var(--space-6) var(--space-16);
  }

  .roadmap-hero {
    text-align: center;
    padding: var(--space-12) 0 var(--space-8);
  }

  .roadmap-hero h1 {
    font-size: var(--text-5xl);
    font-weight: var(--weight-bold);
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-success) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-4);
  }

  .roadmap-subtitle {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-8);
  }

  .stats {
    display: flex;
    justify-content: center;
    gap: var(--space-8);
    flex-wrap: wrap;
  }

  .stat {
    text-align: center;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5) var(--space-8);
    width: 160px;
  }

  .stat-value {
    display: block;
    font-size: var(--text-4xl);
    font-weight: var(--weight-bold);
    color: var(--color-accent);
    font-family: var(--font-mono);
    margin-bottom: var(--space-1);
  }

  .stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  /* Status Sections (In Progress, Planned, Completed) */
  .status-section {
    margin-bottom: var(--space-4);
  }

  .status-section details {
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  /* In Progress Section */
  .in-progress-section details {
    background: rgba(251, 191, 36, 0.02);
    border: 1px solid rgba(251, 191, 36, 0.15);
  }

  .in-progress-section details[open] {
    background: rgba(251, 191, 36, 0.03);
  }

  .status-header.in-progress h2 {
    color: var(--color-warning);
  }

  .status-header.in-progress .status-icon {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .in-progress-section .progress-fill {
    background: var(--color-warning);
  }

  /* Planned Section */
  .planned-section details {
    background: rgba(148, 163, 184, 0.02);
    border: 1px solid rgba(148, 163, 184, 0.12);
  }

  .planned-section details[open] {
    background: rgba(148, 163, 184, 0.03);
  }

  .status-header.planned h2 {
    color: var(--color-text-secondary);
  }

  .status-header.planned .status-icon {
    background: rgba(148, 163, 184, 0.15);
    color: var(--color-text-secondary);
  }

  /* Completed Section */
  .completed-section details {
    background: rgba(74, 222, 128, 0.02);
    border: 1px solid rgba(74, 222, 128, 0.15);
  }

  .completed-section details[open] {
    background: rgba(74, 222, 128, 0.03);
  }

  .status-header.completed h2 {
    color: var(--color-success);
  }

  .status-header.completed .status-icon {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .completed-section .progress-fill {
    background: var(--color-success);
  }

  /* Common Status Header Styles */
  .status-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-5);
    cursor: pointer;
    list-style: none;
  }

  .status-header::-webkit-details-marker {
    display: none;
  }

  .status-header h2 {
    font-size: var(--text-lg);
    font-weight: var(--weight-semibold);
    margin: 0;
    flex: 1;
  }

  .status-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: var(--text-sm);
    font-weight: var(--weight-bold);
  }

  .status-count {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    background: var(--color-bg-tertiary);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }

  .expand-icon {
    width: 20px;
    height: 20px;
    position: relative;
    color: var(--color-text-muted);
  }

  .expand-icon::before {
    content: "▸";
    font-size: var(--text-sm);
    transition: transform 0.2s ease;
    display: inline-block;
  }

  details[open] .expand-icon::before {
    transform: rotate(90deg);
  }

  .status-phases {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: var(--space-3);
    padding: 0 var(--space-4) var(--space-4);
  }

  .status-section .phase-card {
    background: var(--color-bg-secondary);
  }

  .status-section .phase-card:hover {
    background: var(--color-bg-tertiary);
  }

  /* Phases */
  .phase-card {
    display: flex;
    flex-direction: column;
    height: 140px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: left;
    width: 100%;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
    -webkit-appearance: none;
    appearance: none;
    outline: none;
  }

  .phase-card:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .phase-card:hover {
    background: var(--color-bg-tertiary);
    border-color: var(--color-border-hover, var(--color-border));
  }

  .phase-card.complete {
    border-left: 3px solid var(--color-success);
  }

  .phase-card.partial {
    border-left: 3px solid var(--color-warning);
  }

  .phase-card.not-started {
    border-left: 3px solid var(--color-text-muted);
    opacity: 0.8;
  }

  .phase-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
    flex-shrink: 0;
  }

  .phase-num {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    color: var(--color-text-muted);
  }

  .phase-status {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
  }

  .phase-status.success {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .phase-status.warning {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .phase-status.muted {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
  }

  .phase-card h3 {
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-2) 0;
    flex-shrink: 0;
  }

  .phase-progress {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
    margin-top: auto;
  }

  .progress-bar {
    flex: 1;
    height: 4px;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--color-accent);
    border-radius: var(--radius-full);
    transition: width var(--transition-base);
  }

  .phase-card.complete .progress-fill {
    background: var(--color-success);
  }

  .phase-card.partial .progress-fill {
    background: var(--color-warning);
  }

  .progress-text {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    white-space: nowrap;
  }

  .phase-note {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin: 0;
    flex: 1;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-clamp: 2;
    min-height: 0;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s;
    padding: var(--space-4);
  }

  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .modal-content {
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    max-width: 480px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
  }

  .modal-close {
    position: absolute;
    top: var(--space-2);
    right: var(--space-2);
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
  }

  .modal-close:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
  }

  .modal-header {
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid var(--color-border);
  }

  .modal-phase-num {
    font-size: 10px;
    font-weight: var(--weight-medium);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .modal-title {
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-1) 0;
    padding-right: var(--space-6);
  }

  .modal-status {
    display: inline-block;
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
  }

  .modal-status.success {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .modal-status.warning {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .modal-status.muted {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
  }

  .modal-goal {
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin: 0;
    border-bottom: 1px solid var(--color-border);
  }

  .modal-spec {
    display: none;
  }

  .modal-sections {
    padding: var(--space-3) var(--space-4);
  }

  .modal-section {
    margin-bottom: var(--space-3);
  }

  .modal-section:last-child {
    margin-bottom: 0;
  }

  :global(.modal-section h4) {
    font-size: 11px;
    font-weight: 600;
    color: var(--color-text-muted);
    margin: 0 0 4px 0;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  :global(.task-list) {
    margin: 0 0 12px 0;
    padding-left: 20px;
    list-style: disc;
  }

  :global(.task-list li) {
    font-size: 12px;
    line-height: 1.4;
    margin-bottom: 2px;
  }

  :global(.task-list li.done) {
    color: var(--color-text-secondary);
  }

  :global(.task-list li.pending) {
    color: var(--color-text-muted);
  }

  /* Dependency Graph */
  .dependency-graph {
    margin-top: var(--space-12);
    margin-bottom: var(--space-12);
  }

  .dependency-graph h2 {
    font-size: var(--text-xl);
    font-weight: var(--weight-semibold);
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
  }

  .graph-container {
    background: var(--color-bg-code);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    overflow-x: auto;
  }

  .graph {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
    white-space: pre;
  }

  /* Test Results */
  .test-results {
    margin-bottom: var(--space-12);
  }

  .test-results h2 {
    font-size: var(--text-xl);
    font-weight: var(--weight-semibold);
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .result-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    text-align: center;
  }

  .result-value {
    display: block;
    font-size: var(--text-3xl);
    font-weight: var(--weight-bold);
    font-family: var(--font-mono);
    color: var(--color-text-primary);
  }

  .result-label {
    display: block;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
  }

  .result-status {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    padding: 2px 8px;
    border-radius: var(--radius-full);
  }

  .result-status.success {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .result-status.muted {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
  }

  /* CTA */
  .roadmap-cta {
    text-align: center;
    padding: var(--space-12) var(--space-6);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-border);
  }

  .roadmap-cta h2 {
    font-size: var(--text-2xl);
    font-weight: var(--weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
  }

  .roadmap-cta p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .roadmap-cta code {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    background: var(--color-bg-code);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
    color: var(--color-accent);
  }

  .cta-buttons {
    display: flex;
    gap: var(--space-4);
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-weight: var(--weight-semibold);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .btn-primary {
    background: var(--color-accent);
    color: #fff;
  }

  .btn-primary:hover {
    background: var(--color-accent-hover);
    color: #fff;
  }

  .btn-secondary {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-bg-elevated);
    color: var(--color-text-primary);
    border-color: var(--color-border-hover);
  }

  /* Proposals Section */
  .proposals-section {
    margin-top: var(--space-12);
    margin-bottom: var(--space-12);
  }

  .proposals-section > h2 {
    font-size: var(--text-2xl);
    font-weight: var(--weight-bold);
    margin-bottom: var(--space-2);
    color: var(--color-text-primary);
  }

  .proposals-subtitle {
    font-size: var(--text-base);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
  }

  .proposal-stats {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
  }

  .proposal-stat {
    font-size: var(--text-sm);
    font-weight: var(--weight-medium);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }

  .proposal-stat.approved {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .proposal-stat.draft {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .proposal-stat.rejected {
    background: rgba(239, 68, 68, 0.15);
    color: var(--color-error, #ef4444);
  }

  .proposal-categories {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* Approved Proposals Section */
  .approved-proposals-section details {
    background: rgba(74, 222, 128, 0.02);
    border: 1px solid rgba(74, 222, 128, 0.15);
    border-radius: var(--radius-lg);
  }

  .approved-proposals-section details[open] {
    background: rgba(74, 222, 128, 0.03);
  }

  .status-header.approved-header h3 {
    color: var(--color-success);
  }

  .status-header.approved-header .status-icon {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  /* Draft Proposals Section */
  .draft-proposals-section details {
    background: rgba(251, 191, 36, 0.02);
    border: 1px solid rgba(251, 191, 36, 0.15);
    border-radius: var(--radius-lg);
  }

  .draft-proposals-section details[open] {
    background: rgba(251, 191, 36, 0.03);
  }

  .status-header.draft-header h3 {
    color: var(--color-warning);
  }

  .status-header.draft-header .status-icon {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  /* Rejected Proposals Section */
  .rejected-proposals-section details {
    background: rgba(239, 68, 68, 0.02);
    border: 1px solid rgba(239, 68, 68, 0.15);
    border-radius: var(--radius-lg);
  }

  .rejected-proposals-section details[open] {
    background: rgba(239, 68, 68, 0.03);
  }

  .status-header.rejected-header h3 {
    color: var(--color-error, #ef4444);
  }

  .status-header.rejected-header .status-icon {
    background: rgba(239, 68, 68, 0.15);
    color: var(--color-error, #ef4444);
  }

  .proposals-section .status-header h3 {
    font-size: var(--text-lg);
    font-weight: var(--weight-semibold);
    margin: 0;
    flex: 1;
  }

  .proposal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-3);
    padding: 0 var(--space-4) var(--space-4);
  }

  .proposal-card {
    display: flex;
    flex-direction: column;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .proposal-card:hover {
    background: var(--color-bg-tertiary);
    border-color: var(--color-border-hover, var(--color-border));
    transform: translateY(-1px);
  }

  .proposal-card.approved {
    border-left: 3px solid var(--color-success);
  }

  .proposal-card.draft {
    border-left: 3px solid var(--color-warning);
  }

  .proposal-card.rejected {
    border-left: 3px solid var(--color-error, #ef4444);
  }

  .proposal-card h4 {
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-2) 0;
    line-height: 1.3;
  }

  .proposal-summary {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin: 0 0 var(--space-3) 0;
    flex: 1;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .proposal-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: auto;
  }


  @media (max-width: 768px) {
    .roadmap-hero h1 {
      font-size: var(--text-4xl);
    }

    .stats {
      gap: var(--space-6);
    }

    .phases {
      grid-template-columns: 1fr;
    }

    .tier {
      padding-left: var(--space-4);
    }

    .modal-content {
      padding: var(--space-4);
    }

    .modal-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .proposal-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
