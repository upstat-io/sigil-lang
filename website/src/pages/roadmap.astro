---
import BaseLayout from '../layouts/BaseLayout.astro';
import { readFileSync, readdirSync, existsSync } from 'fs';
import { join, basename } from 'path';

// Proposal loading
interface Proposal {
  title: string;
  status: 'approved' | 'draft' | 'rejected';
  author?: string;
  created?: string;
  approved?: string;
  rejected?: string;
  summary?: string;
  filename: string;
  path: string;
}

function parseProposal(content: string, filename: string, dir: string, status: 'approved' | 'draft' | 'rejected'): Proposal {
  const lines = content.split('\n');

  // Extract title from first H1
  const titleMatch = lines[0]?.match(/^#\s+(?:Proposal:\s*)?(.+)/);
  const title = titleMatch ? titleMatch[1].trim() : filename.replace(/-proposal\.md$/, '').replace(/-/g, ' ');

  // Extract metadata from **Key:** Value format
  const getField = (key: string): string | undefined => {
    const regex = new RegExp(`\\*\\*${key}:\\*\\*\\s*(.+)`, 'i');
    for (const line of lines.slice(0, 20)) {
      const match = line.match(regex);
      if (match) return match[1].trim();
    }
    return undefined;
  };

  // Extract summary - first paragraph after "## Summary"
  let summary: string | undefined;
  const summaryIdx = lines.findIndex(l => l.match(/^##\s+Summary/i));
  if (summaryIdx !== -1) {
    const summaryLines: string[] = [];
    for (let i = summaryIdx + 1; i < lines.length; i++) {
      const line = lines[i];
      if (line.startsWith('#') || line.startsWith('---')) break;
      if (line.trim()) summaryLines.push(line.trim());
      else if (summaryLines.length > 0) break;
    }
    summary = summaryLines.join(' ').slice(0, 200);
    if (summary.length === 200) summary += '...';
  }

  return {
    title,
    status,
    author: getField('Author'),
    created: getField('Created'),
    approved: getField('Approved'),
    rejected: getField('Rejected'),
    summary,
    filename,
    path: `proposals/${dir}/${filename}`,
  };
}

function loadProposals(dir: string, status: 'approved' | 'draft' | 'rejected'): Proposal[] {
  const proposalsDir = join(process.cwd(), '..', 'docs', 'ori_lang', 'proposals', dir);
  if (!existsSync(proposalsDir)) return [];

  const files = readdirSync(proposalsDir).filter(f => f.endsWith('.md'));
  return files.map(file => {
    const content = readFileSync(join(proposalsDir, file), 'utf-8');
    return parseProposal(content, file, dir, status);
  }).sort((a, b) => {
    // Sort by created date descending, then by title
    if (a.created && b.created) {
      return b.created.localeCompare(a.created);
    }
    return a.title.localeCompare(b.title);
  });
}

const approvedProposals = loadProposals('approved', 'approved');
const draftProposals = loadProposals('drafts', 'draft');
const rejectedProposals = loadProposals('rejected', 'rejected');

// Format date to US standard (e.g., "January 27, 2026")
function formatDate(dateStr: string | undefined): string | undefined {
  if (!dateStr) return undefined;
  const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!match) return dateStr;
  const [, year, month, day] = match;
  const months = ['January', 'February', 'March', 'April', 'May', 'June',
                  'July', 'August', 'September', 'October', 'November', 'December'];
  const monthName = months[parseInt(month, 10) - 1];
  return `${monthName} ${parseInt(day, 10)}, ${year}`;
}

interface Task {
  name: string;
  done: boolean;
}

interface Section {
  name: string;
  tasks: Task[];
}

interface Phase {
  num: number | string;
  name: string;
  status: "complete" | "partial" | "not-started";
  note?: string;
  goal: string;
  spec?: string;
  sections: Section[];
}

interface Tier {
  id: number;
  name: string;
  status: string;
  description: string;
  phases: Phase[];
  milestone: string;
  milestoneStatus: string;
  exitCriteria: string;
}

// ============================================================================
// Phase File Loading (Dynamic)
// ============================================================================

interface YamlSection {
  id: string;
  title: string;
  status: string;
}

interface YamlFrontmatter {
  phase: number | string;
  title: string;
  status: string;
  tier: number;
  goal: string;
  spec?: string | string[];
  sections: YamlSection[];
}

// Parse simple YAML frontmatter (handles our specific schema)
function parseYamlFrontmatter(yaml: string): YamlFrontmatter | null {
  const lines = yaml.trim().split('\n');
  const result: Record<string, unknown> = {};
  let currentKey = '';
  let currentArray: unknown[] | null = null;
  let currentObject: Record<string, unknown> | null = null;
  let inArray = false;

  for (const line of lines) {
    if (!line.trim()) continue;

    // Check for array item (starts with "  - ")
    const arrayItemMatch = line.match(/^(\s*)- (.+)$/);
    if (arrayItemMatch) {
      const [, indent, value] = arrayItemMatch;
      const indentLevel = indent.length;

      const objectMatch = value.match(/^(\w+):\s*(.*)$/);
      if (objectMatch && indentLevel >= 2) {
        const [, key, val] = objectMatch;
        if (key === 'id') {
          if (currentObject && currentArray) {
            currentArray.push(currentObject);
          }
          currentObject = { id: val.replace(/^["']|["']$/g, '') };
        } else if (currentObject) {
          currentObject[key] = val.replace(/^["']|["']$/g, '');
        }
      } else if (inArray && currentArray) {
        currentArray.push(value.trim());
      }
      continue;
    }

    // Check for indented object property (continuation of array object)
    const indentedKvMatch = line.match(/^(\s+)(\w+):\s*(.*)$/);
    if (indentedKvMatch && currentObject) {
      const [, indent, key, val] = indentedKvMatch;
      if (indent.length >= 4) {
        currentObject[key] = val.replace(/^["']|["']$/g, '');
        continue;
      }
    }

    // Top-level key: value
    const kvMatch = line.match(/^(\w+):\s*(.*)$/);
    if (kvMatch) {
      if (currentKey && currentArray) {
        if (currentObject) {
          currentArray.push(currentObject);
          currentObject = null;
        }
        result[currentKey] = currentArray;
        currentArray = null;
      }

      const [, key, value] = kvMatch;
      currentKey = key;

      if (value === '' || value === undefined) {
        currentArray = [];
        inArray = true;
      } else {
        let parsed: unknown = value.replace(/^["']|["']$/g, '');
        if (parsed === 'true') parsed = true;
        else if (parsed === 'false') parsed = false;
        else if (/^\d+$/.test(parsed as string)) parsed = parseInt(parsed as string, 10);
        result[key] = parsed;
        inArray = false;
      }
    }
  }

  if (currentKey && currentArray) {
    if (currentObject) {
      currentArray.push(currentObject);
    }
    result[currentKey] = currentArray;
  }

  return result as unknown as YamlFrontmatter;
}

// Extract tasks from markdown body by parsing checkboxes under section headers
function extractTasksFromBody(body: string): Map<string, Task[]> {
  const result = new Map<string, Task[]>();
  const lines = body.split('\n');

  let currentSectionId = '';
  let currentTasks: Task[] = [];

  for (const line of lines) {
    const sectionMatch = line.match(/^##\s+(\d+(?:\.\d+)?[A-Z]?)\s+(.+)/);
    if (sectionMatch) {
      if (currentSectionId) {
        result.set(currentSectionId, currentTasks);
      }
      currentSectionId = sectionMatch[1];
      currentTasks = [];
      continue;
    }

    // Match: - [x] **Verb**: Description text — optional spec reference
    const checkboxMatch = line.match(/^-\s+\[([ xX])\]\s+\*\*(.+?)\*\*:?\s*(.*)/);
    if (checkboxMatch && currentSectionId) {
      const done = checkboxMatch[1].toLowerCase() === 'x';
      const verb = checkboxMatch[2].trim();
      const description = checkboxMatch[3]
        ?.replace(/\s*—\s*spec\/.*$/, '')  // Remove spec reference
        ?.replace(/\s*—\s*[A-Za-z\/]+\.md.*$/, '')  // Remove any .md reference
        ?.replace(/`/g, '')  // Remove backticks
        ?.trim() || '';
      const name = description || verb;  // Use description if available, else verb
      currentTasks.push({ name, done });
      continue;
    }

    // Fallback: Match plain checkbox without bold (e.g., "- [x] Some text here")
    const plainCheckboxMatch = line.match(/^-\s+\[([ xX])\]\s+(.+)/);
    if (plainCheckboxMatch && currentSectionId) {
      const done = plainCheckboxMatch[1].toLowerCase() === 'x';
      const name = plainCheckboxMatch[2]
        ?.replace(/\s*—\s*.*$/, '')  // Remove anything after em-dash
        ?.replace(/`/g, '')  // Remove backticks
        ?.trim() || '';
      if (name) {
        currentTasks.push({ name, done });
      }
    }
  }

  if (currentSectionId) {
    result.set(currentSectionId, currentTasks);
  }

  return result;
}

// Load and parse a single phase file
function loadPhaseFile(filepath: string): Phase | null {
  if (!existsSync(filepath)) return null;

  const content = readFileSync(filepath, 'utf-8');
  if (!content.startsWith('---')) return null;

  const endIndex = content.indexOf('---', 3);
  if (endIndex === -1) return null;

  const frontmatterStr = content.slice(3, endIndex);
  const body = content.slice(endIndex + 3);

  const frontmatter = parseYamlFrontmatter(frontmatterStr);
  if (!frontmatter) return null;

  const tasksMap = extractTasksFromBody(body);

  const sections: Section[] = frontmatter.sections.map(s => ({
    name: `${s.id} ${s.title}`,
    tasks: tasksMap.get(s.id) || [],
  }));

  let doneCount = 0, totalCount = 0;
  for (const section of sections) {
    for (const task of section.tasks) {
      totalCount++;
      if (task.done) doneCount++;
    }
  }

  const status: "complete" | "partial" | "not-started" =
    frontmatter.status === 'complete' ? 'complete' :
    frontmatter.status === 'in-progress' ? 'partial' : 'not-started';

  return {
    num: frontmatter.phase,
    name: frontmatter.title,
    status,
    note: totalCount > 0 ? `${doneCount}/${totalCount} tasks` : undefined,
    goal: frontmatter.goal,
    spec: Array.isArray(frontmatter.spec) ? frontmatter.spec.join(', ') : frontmatter.spec,
    sections,
  };
}

// Load all phase files and organize by tier
function loadAllPhases(): Map<number, Phase[]> {
  const roadmapDir = join(process.cwd(), '..', 'plans', 'roadmap');
  const phases = new Map<number, Phase[]>();

  if (!existsSync(roadmapDir)) return phases;

  const files = readdirSync(roadmapDir)
    .filter(f => f.startsWith('phase-') && f.endsWith('.md'))
    .sort();

  for (const file of files) {
    const filepath = join(roadmapDir, file);
    const content = readFileSync(filepath, 'utf-8');

    const tierMatch = content.match(/^tier:\s*(\d+)/m);
    if (!tierMatch) continue;

    const tier = parseInt(tierMatch[1], 10);
    const phase = loadPhaseFile(filepath);

    if (phase) {
      if (!phases.has(tier)) phases.set(tier, []);
      phases.get(tier)!.push(phase);
    }
  }

  return phases;
}

// Tier metadata (stable, rarely changes)
const tierMetadata: Omit<Tier, 'phases' | 'status'>[] = [
  { id: 1, name: "Foundation", description: "Core type system and language fundamentals", milestone: "M1: Bootstrapped", milestoneStatus: "partial", exitCriteria: "Can write programs using traits and modules" },
  { id: 2, name: "Capabilities & Stdlib", description: "Effect tracking and standard library", milestone: "M2: Capabilities & Stdlib", milestoneStatus: "partial", exitCriteria: "Capabilities working, stdlib available" },
  { id: 3, name: "Core Patterns", description: "Pattern evaluation and control flow", milestone: "M3: Core Patterns", milestoneStatus: "partial", exitCriteria: "run/try/recurse/parallel working, match expressions complete" },
  { id: 4, name: "FFI & Interop", description: "Foreign function interface and C/JS interop", milestone: "M4: FFI & Interop", milestoneStatus: "not-started", exitCriteria: "Can call C and JavaScript functions" },
  { id: 5, name: "Language Completion", description: "Testing, conditional compilation, syntax proposals", milestone: "M5: Language Complete", milestoneStatus: "not-started", exitCriteria: "All core language features implemented" },
  { id: 6, name: "Async & Concurrency", description: "Async/await and concurrent execution", milestone: "M6: Production Async", milestoneStatus: "not-started", exitCriteria: "Full async support with channels and nurseries" },
  { id: 7, name: "Advanced Types", description: "Const generics, existential types, reflection", milestone: "M7: Advanced Types", milestoneStatus: "not-started", exitCriteria: "Advanced type system features complete" },
  { id: 8, name: "Advanced Features", description: "LLVM backend, AOT compilation, tooling", milestone: "M8: Full Featured", milestoneStatus: "partial", exitCriteria: "Full IDE support, generic serialization, native binaries" },
];

// Build tiers with dynamically loaded phases
function buildTiers(): Tier[] {
  const phasesByTier = loadAllPhases();

  return tierMetadata.map(meta => {
    const phases = phasesByTier.get(meta.id) || [];

    let status: string;
    if (phases.length === 0 || phases.every(p => p.status === 'not-started')) {
      status = 'not-started';
    } else if (phases.every(p => p.status === 'complete')) {
      status = 'complete';
    } else {
      status = 'partial';
    }

    return { ...meta, phases, status };
  });
}

const tiers: Tier[] = buildTiers();

// ============================================================================
// End Phase File Loading
// ============================================================================

const _legacyDataRemoved = "Hard-coded phase data removed - now loaded from plans/roadmap/phase-*.md";
const statusLabels: Record<string, string> = {
  "complete": "Complete",
  "partial": "In Progress",
  "in-progress": "In Progress",
  "not-started": "Not Started",
  "planned": "Planned",
  "future": "Future",
  "near-complete": "Near Complete",
};

// Extract phases by status for the collapsible sections
const completedPhases: Phase[] = [];
const inProgressPhases: Phase[] = [];
const plannedPhases: Phase[] = [];

for (const tier of tiers) {
  for (const phase of tier.phases) {
    if (phase.status === "complete") {
      completedPhases.push(phase);
    } else if (phase.status === "partial") {
      inProgressPhases.push(phase);
    } else {
      plannedPhases.push(phase);
    }
  }
}

const statusColors: Record<string, string> = {
  "complete": "success",
  "partial": "warning",
  "in-progress": "warning",
  "not-started": "muted",
  "planned": "muted",
  "future": "muted",
  "near-complete": "warning",
};

function countTasks(sections: Section[]): { done: number; total: number } {
  let done = 0;
  let total = 0;
  for (const section of sections) {
    for (const task of section.tasks) {
      total++;
      if (task.done) done++;
    }
  }
  return { done, total };
}
---

<BaseLayout
  title="Roadmap — Ori"
  description="Ori compiler roadmap: 22 phases across 8 tiers. Track progress on type system, traits, capabilities, async, FFI, LLVM backend, and tooling."
  keywords="Ori roadmap, compiler development, language features, type system, async, FFI, LLVM, tooling"
>
  <main class="roadmap-page">
    <section class="roadmap-hero">
      <h1>Compiler Roadmap</h1>
      <p class="roadmap-subtitle">
        {tiers.reduce((acc, t) => acc + t.phases.length, 0)} phases across {tiers.length} tiers. Click any phase to view details.
      </p>
      <div class="stats">
        <div class="stat">
          <span class="stat-value">{completedPhases.length}</span>
          <span class="stat-label">Completed</span>
        </div>
        <div class="stat">
          <span class="stat-value">{inProgressPhases.length}</span>
          <span class="stat-label">In Progress</span>
        </div>
        <div class="stat">
          <span class="stat-value">{plannedPhases.length}</span>
          <span class="stat-label">Planned</span>
        </div>
      </div>
    </section>

    <section class="status-section in-progress-section">
      <details open>
        <summary class="status-header in-progress">
          <span class="status-icon">◐</span>
          <h2>In Progress</h2>
          <span class="status-count">{inProgressPhases.length} phases</span>
          <span class="expand-icon"></span>
        </summary>
        <div class="status-phases">
          {inProgressPhases.map((phase) => {
            const { done, total } = countTasks(phase.sections);
            return (
              <button
                class="phase-card partial"
                data-phase={JSON.stringify(phase)}
                type="button"
              >
                <div class="phase-header">
                  <span class="phase-num">Phase {phase.num}</span>
                  <span class="phase-status warning">In Progress</span>
                </div>
                <h3>{phase.name}</h3>
                <p class="phase-note">{phase.note || phase.goal}</p>
                <div class="phase-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style={`width: ${total > 0 ? (done / total) * 100 : 0}%`}></div>
                  </div>
                  <span class="progress-text">{done}/{total} tasks</span>
                </div>
              </button>
            );
          })}
        </div>
      </details>
    </section>

    <section class="status-section planned-section">
      <details open>
        <summary class="status-header planned">
          <span class="status-icon">○</span>
          <h2>Planned</h2>
          <span class="status-count">{plannedPhases.length} phases</span>
          <span class="expand-icon"></span>
        </summary>
        <div class="status-phases">
          {plannedPhases.map((phase) => {
            const { done, total } = countTasks(phase.sections);
            return (
              <button
                class="phase-card not-started"
                data-phase={JSON.stringify(phase)}
                type="button"
              >
                <div class="phase-header">
                  <span class="phase-num">Phase {phase.num}</span>
                  <span class="phase-status muted">Not Started</span>
                </div>
                <h3>{phase.name}</h3>
                <p class="phase-note">{phase.note || phase.goal}</p>
                <div class="phase-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style={`width: ${total > 0 ? (done / total) * 100 : 0}%`}></div>
                  </div>
                  <span class="progress-text">{done}/{total} tasks</span>
                </div>
              </button>
            );
          })}
        </div>
      </details>
    </section>

    <section class="status-section completed-section">
      <details>
        <summary class="status-header completed">
          <span class="status-icon">✓</span>
          <h2>Completed</h2>
          <span class="status-count">{completedPhases.length} phases</span>
          <span class="expand-icon"></span>
        </summary>
        <div class="status-phases">
          {completedPhases.map((phase) => {
            const { done, total } = countTasks(phase.sections);
            return (
              <button
                class="phase-card complete"
                data-phase={JSON.stringify(phase)}
                type="button"
              >
                <div class="phase-header">
                  <span class="phase-num">Phase {phase.num}</span>
                  <span class="phase-status success">Complete</span>
                </div>
                <h3>{phase.name}</h3>
                <p class="phase-note">{phase.note || phase.goal}</p>
                <div class="phase-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style={`width: 100%`}></div>
                  </div>
                  <span class="progress-text">{done}/{total} tasks</span>
                </div>
              </button>
            );
          })}
        </div>
      </details>
    </section>

    <section class="dependency-graph">
      <h2>Dependency Graph</h2>
      <div class="graph-container">
        <pre class="graph">{`Phase 1 (Types) → Phase 2 (Inference) → Phase 3 (Traits) → Phase 4 (Modules)
    → Phase 5 (Type Decls) → Phase 6 (Capabilities) → Phase 7A-D (Stdlib)
    → Phase 8 (Patterns) → Phase 9 (Match) → Phase 10 (Control Flow)
    → Phase 11 (FFI) → Phase 12 (Variadics) → Phase 13 (Conditional)
    → Phase 14 (Testing) → Phase 15A-D (Syntax Proposals)

Branches:
  Phase 6 ──→ Phase 16 (Async) → Phase 17 (Concurrency)
  Phase 3 ──→ Phase 19 (Existential Types)
  Phase 2 ──→ Phase 18 (Const Generics)
  Phase 11 ──→ Phase 20 (Reflection)
  Core Complete (1-15) ──→ Phase 21A (LLVM) → Phase 21B (AOT) → Phase 22 (Tooling)`}</pre>
      </div>
    </section>

    <section class="test-results">
      <h2>Current Test Results</h2>
      <div class="results-grid">
        <div class="result-card">
          <span class="result-value">2136</span>
          <span class="result-label">Rust Unit Tests</span>
          <span class="result-status success">All Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">1677</span>
          <span class="result-label">Ori Spec Tests</span>
          <span class="result-status success">Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">977</span>
          <span class="result-label">LLVM Backend Tests</span>
          <span class="result-status success">Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">204</span>
          <span class="result-label">LLVM Rust Tests</span>
          <span class="result-status success">All Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">440</span>
          <span class="result-label">Formatter Tests</span>
          <span class="result-status success">All Passing</span>
        </div>
      </div>
    </section>

    <section class="proposals-section">
      <h2>Language Proposals</h2>
      <p class="proposals-subtitle">
        Design decisions and rationale for language features. Proposals go through draft review before approval or rejection.
      </p>
      <div class="proposal-stats">
        <span class="proposal-stat approved">{approvedProposals.length} approved</span>
        <span class="proposal-stat draft">{draftProposals.length} drafts</span>
        <span class="proposal-stat rejected">{rejectedProposals.length} rejected</span>
      </div>

      <div class="proposal-categories">
        <section class="status-section draft-proposals-section">
          <details open>
            <summary class="status-header draft-header">
              <span class="status-icon">◐</span>
              <h3>Drafts</h3>
              <span class="status-count">{draftProposals.length} proposals</span>
              <span class="expand-icon"></span>
            </summary>
            <div class="proposal-grid">
              {draftProposals.map((proposal) => (
                <a
                  href={`https://github.com/upstat-io/ori-lang/blob/master/docs/ori_lang/${proposal.path}`}
                  class="proposal-card draft"
                  target="_blank"
                  rel="noopener"
                >
                  <h4>{proposal.title}</h4>
                  {proposal.summary && <p class="proposal-summary">{proposal.summary}</p>}
                  <div class="proposal-meta">
                    {proposal.author && <span class="proposal-author">{proposal.author}</span>}
                    {proposal.created && <span class="proposal-date">Created {formatDate(proposal.created)}</span>}
                  </div>
                </a>
              ))}
            </div>
          </details>
        </section>

        <section class="status-section approved-proposals-section">
          <details>
            <summary class="status-header approved-header">
              <span class="status-icon">✓</span>
              <h3>Approved</h3>
              <span class="status-count">{approvedProposals.length} proposals</span>
              <span class="expand-icon"></span>
            </summary>
            <div class="proposal-grid">
              {approvedProposals.map((proposal) => (
                <a
                  href={`https://github.com/upstat-io/ori-lang/blob/master/docs/ori_lang/${proposal.path}`}
                  class="proposal-card approved"
                  target="_blank"
                  rel="noopener"
                >
                  <h4>{proposal.title}</h4>
                  {proposal.summary && <p class="proposal-summary">{proposal.summary}</p>}
                  <div class="proposal-meta">
                    {proposal.author && <span class="proposal-author">{proposal.author}</span>}
                    {proposal.approved && <span class="proposal-date">Approved {formatDate(proposal.approved)}</span>}
                  </div>
                </a>
              ))}
            </div>
          </details>
        </section>

        <section class="status-section rejected-proposals-section">
          <details>
            <summary class="status-header rejected-header">
              <span class="status-icon">✕</span>
              <h3>Rejected</h3>
              <span class="status-count">{rejectedProposals.length} proposals</span>
              <span class="expand-icon"></span>
            </summary>
            <div class="proposal-grid">
              {rejectedProposals.map((proposal) => (
                <a
                  href={`https://github.com/upstat-io/ori-lang/blob/master/docs/ori_lang/${proposal.path}`}
                  class="proposal-card rejected"
                  target="_blank"
                  rel="noopener"
                >
                  <h4>{proposal.title}</h4>
                  {proposal.summary && <p class="proposal-summary">{proposal.summary}</p>}
                  <div class="proposal-meta">
                    {proposal.author && <span class="proposal-author">{proposal.author}</span>}
                    {proposal.rejected && <span class="proposal-date">Rejected {formatDate(proposal.rejected)}</span>}
                  </div>
                </a>
              ))}
            </div>
          </details>
        </section>
      </div>
    </section>

    <section class="roadmap-cta">
      <h2>Want to contribute?</h2>
      <p>The roadmap lives in <code>plans/roadmap/</code>. Each phase has detailed implementation tasks.</p>
      <div class="cta-buttons">
        <a href="https://github.com/upstat-io/ori-lang/tree/master/plans/roadmap" class="btn btn-primary" target="_blank" rel="noopener">View Full Roadmap</a>
        <a href="https://github.com/upstat-io/ori-lang" class="btn btn-secondary" target="_blank" rel="noopener">GitHub</a>
      </div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modal-overlay" id="phase-modal">
    <div class="modal-container">
      <div class="modal-header">
        <div class="modal-header-content">
          <div class="modal-phase-num" id="modal-phase-num"></div>
          <h2 class="modal-title" id="modal-title"></h2>
          <span class="modal-status" id="modal-status"></span>
        </div>
        <button class="modal-close" type="button" aria-label="Close modal">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-goal" id="modal-goal"></p>
        <div class="modal-sections" id="modal-sections"></div>
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline>
  (function() {
    const modal = document.getElementById('phase-modal');
    const modalClose = modal ? modal.querySelector('.modal-close') : null;
    const phaseCards = document.querySelectorAll('.phase-card');

    const statusLabels = {
      "complete": "Complete",
      "partial": "In Progress",
      "not-started": "Not Started"
    };

    const statusColors = {
      "complete": "success",
      "partial": "warning",
      "not-started": "muted"
    };

    function openModal(phaseData) {
      if (!phaseData || !modal) return;

      const phase = JSON.parse(phaseData);

      var phaseNum = document.getElementById('modal-phase-num');
      var title = document.getElementById('modal-title');
      var status = document.getElementById('modal-status');
      var goal = document.getElementById('modal-goal');
      var sections = document.getElementById('modal-sections');

      if (phaseNum) phaseNum.textContent = 'Phase ' + phase.num;
      if (title) title.textContent = phase.name;
      if (status) {
        status.textContent = statusLabels[phase.status] || phase.status;
        status.className = 'modal-status ' + (statusColors[phase.status] || 'muted');
      }
      if (goal) goal.textContent = phase.goal;

      if (sections) {
        var html = '';
        for (var i = 0; i < phase.sections.length; i++) {
          var section = phase.sections[i];
          html += '<div class="modal-section">';
          html += '<h4>' + section.name + '</h4>';
          html += '<ul class="task-list">';
          for (var j = 0; j < section.tasks.length; j++) {
            var task = section.tasks[j];
            var cls = task.done ? 'done' : 'pending';
            html += '<li class="' + cls + '">' + task.name + '</li>';
          }
          html += '</ul>';
          html += '</div>';
        }
        sections.innerHTML = html;
      }

      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    for (var i = 0; i < phaseCards.length; i++) {
      (function(card) {
        card.addEventListener('click', function(e) {
          e.preventDefault();
          var phaseData = card.getAttribute('data-phase');
          openModal(phaseData);
        });
      })(phaseCards[i]);
    }

    if (modalClose) {
      modalClose.addEventListener('click', closeModal);
    }

    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
      });
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });
  })();
</script>

<style>
  .roadmap-page {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--space-8) var(--space-6) var(--space-16);
  }

  .roadmap-hero {
    text-align: center;
    padding: var(--space-12) 0 var(--space-8);
  }

  .roadmap-hero h1 {
    font-size: var(--text-5xl);
    font-weight: var(--weight-bold);
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-success) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-4);
  }

  .roadmap-subtitle {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-8);
  }

  .stats {
    display: flex;
    justify-content: center;
    gap: var(--space-8);
    flex-wrap: wrap;
  }

  .stat {
    text-align: center;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5) var(--space-8);
    width: 160px;
  }

  .stat-value {
    display: block;
    font-size: var(--text-4xl);
    font-weight: var(--weight-bold);
    color: var(--color-accent);
    font-family: var(--font-mono);
    margin-bottom: var(--space-1);
  }

  .stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  /* Status Sections (In Progress, Planned, Completed) */
  .status-section {
    margin-bottom: var(--space-4);
  }

  .status-section details {
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  /* In Progress Section */
  .in-progress-section details {
    background: rgba(251, 191, 36, 0.02);
    border: 1px solid rgba(251, 191, 36, 0.15);
  }

  .in-progress-section details[open] {
    background: rgba(251, 191, 36, 0.03);
  }

  .status-header.in-progress h2 {
    color: var(--color-warning);
  }

  .status-header.in-progress .status-icon {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .in-progress-section .progress-fill {
    background: var(--color-warning);
  }

  /* Planned Section */
  .planned-section details {
    background: rgba(148, 163, 184, 0.02);
    border: 1px solid rgba(148, 163, 184, 0.12);
  }

  .planned-section details[open] {
    background: rgba(148, 163, 184, 0.03);
  }

  .status-header.planned h2 {
    color: var(--color-text-secondary);
  }

  .status-header.planned .status-icon {
    background: rgba(148, 163, 184, 0.15);
    color: var(--color-text-secondary);
  }

  /* Completed Section */
  .completed-section details {
    background: rgba(74, 222, 128, 0.02);
    border: 1px solid rgba(74, 222, 128, 0.15);
  }

  .completed-section details[open] {
    background: rgba(74, 222, 128, 0.03);
  }

  .status-header.completed h2 {
    color: var(--color-success);
  }

  .status-header.completed .status-icon {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .completed-section .progress-fill {
    background: var(--color-success);
  }

  /* Common Status Header Styles */
  .status-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-5);
    cursor: pointer;
    list-style: none;
  }

  .status-header::-webkit-details-marker {
    display: none;
  }

  .status-header h2 {
    font-size: var(--text-lg);
    font-weight: var(--weight-semibold);
    margin: 0;
    flex: 1;
  }

  .status-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: var(--text-sm);
    font-weight: var(--weight-bold);
  }

  .status-count {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    background: var(--color-bg-tertiary);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }

  .expand-icon {
    width: 20px;
    height: 20px;
    position: relative;
    color: var(--color-text-muted);
  }

  .expand-icon::before {
    content: "▸";
    font-size: var(--text-sm);
    transition: transform 0.2s ease;
    display: inline-block;
  }

  details[open] .expand-icon::before {
    transform: rotate(90deg);
  }

  .status-phases {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: var(--space-3);
    padding: 0 var(--space-4) var(--space-4);
  }

  .status-section .phase-card {
    background: var(--color-bg-secondary);
  }

  .status-section .phase-card:hover {
    background: var(--color-bg-tertiary);
  }

  /* Phases */
  .phase-card {
    display: flex;
    flex-direction: column;
    height: 140px;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: left;
    width: 100%;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
    -webkit-appearance: none;
    appearance: none;
    outline: none;
  }

  .phase-card:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .phase-card:hover {
    background: var(--color-bg-tertiary);
    border-color: var(--color-border-hover, var(--color-border));
  }

  .phase-card.complete {
    border-left: 3px solid var(--color-success);
  }

  .phase-card.partial {
    border-left: 3px solid var(--color-warning);
  }

  .phase-card.not-started {
    border-left: 3px solid var(--color-text-muted);
    opacity: 0.8;
  }

  .phase-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
    flex-shrink: 0;
  }

  .phase-num {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    color: var(--color-text-muted);
  }

  .phase-status {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
  }

  .phase-status.success {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .phase-status.warning {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .phase-status.muted {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
  }

  .phase-card h3 {
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-2) 0;
    flex-shrink: 0;
  }

  .phase-progress {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
    margin-top: auto;
  }

  .progress-bar {
    flex: 1;
    height: 4px;
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-full);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--color-accent);
    border-radius: var(--radius-full);
    transition: width var(--transition-base);
  }

  .phase-card.complete .progress-fill {
    background: var(--color-success);
  }

  .phase-card.partial .progress-fill {
    background: var(--color-warning);
  }

  .progress-text {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    white-space: nowrap;
  }

  .phase-note {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin: 0;
    flex: 1;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-clamp: 2;
    min-height: 0;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s;
    padding: var(--space-4);
  }

  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .modal-container {
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    max-width: 480px;
    width: 100%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .modal-header {
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-shrink: 0;
  }

  .modal-header-content {
    flex: 1;
  }

  .modal-close {
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    color: var(--color-text-muted);
    font-size: var(--text-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    flex-shrink: 0;
    margin-left: var(--space-2);
  }

  .modal-close:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
  }

  .modal-body {
    overflow-y: auto;
    flex: 1;
    padding: var(--space-4);
  }

  .modal-phase-num {
    font-size: 10px;
    font-weight: var(--weight-medium);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .modal-title {
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-1) 0;
    padding-right: var(--space-6);
  }

  .modal-status {
    display: inline-block;
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
  }

  .modal-status.success {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .modal-status.warning {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .modal-status.muted {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
  }

  .modal-goal {
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin: 0;
    border-bottom: 1px solid var(--color-border);
  }

  .modal-spec {
    display: none;
  }

  .modal-sections {
    padding: var(--space-3) var(--space-4);
  }

  .modal-section {
    margin-bottom: var(--space-3);
  }

  .modal-section:last-child {
    margin-bottom: 0;
  }

  :global(.modal-section h4) {
    font-size: 11px;
    font-weight: 600;
    color: var(--color-text-muted);
    margin: 0 0 4px 0;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  :global(.task-list) {
    margin: 0 0 12px 0;
    padding-left: 20px;
    list-style: disc;
  }

  :global(.task-list li) {
    font-size: 12px;
    line-height: 1.4;
    margin-bottom: 2px;
  }

  :global(.task-list li.done) {
    color: var(--color-text-secondary);
  }

  :global(.task-list li.pending) {
    color: var(--color-text-muted);
  }

  /* Dependency Graph */
  .dependency-graph {
    margin-top: var(--space-12);
    margin-bottom: var(--space-12);
  }

  .dependency-graph h2 {
    font-size: var(--text-xl);
    font-weight: var(--weight-semibold);
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
  }

  .graph-container {
    background: var(--color-bg-code);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    overflow-x: auto;
  }

  .graph {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
    white-space: pre;
  }

  /* Test Results */
  .test-results {
    margin-bottom: var(--space-12);
  }

  .test-results h2 {
    font-size: var(--text-xl);
    font-weight: var(--weight-semibold);
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .result-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    text-align: center;
  }

  .result-value {
    display: block;
    font-size: var(--text-3xl);
    font-weight: var(--weight-bold);
    font-family: var(--font-mono);
    color: var(--color-text-primary);
  }

  .result-label {
    display: block;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
  }

  .result-status {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    padding: 2px 8px;
    border-radius: var(--radius-full);
  }

  .result-status.success {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .result-status.muted {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
  }

  /* CTA */
  .roadmap-cta {
    text-align: center;
    padding: var(--space-12) var(--space-6);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-border);
  }

  .roadmap-cta h2 {
    font-size: var(--text-2xl);
    font-weight: var(--weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
  }

  .roadmap-cta p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .roadmap-cta code {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    background: var(--color-bg-code);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
    color: var(--color-accent);
  }

  .cta-buttons {
    display: flex;
    gap: var(--space-4);
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-weight: var(--weight-semibold);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .btn-primary {
    background: var(--color-accent);
    color: #fff;
  }

  .btn-primary:hover {
    background: var(--color-accent-hover);
    color: #fff;
  }

  .btn-secondary {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-bg-elevated);
    color: var(--color-text-primary);
    border-color: var(--color-border-hover);
  }

  /* Proposals Section */
  .proposals-section {
    margin-top: var(--space-12);
    margin-bottom: var(--space-12);
  }

  .proposals-section > h2 {
    font-size: var(--text-2xl);
    font-weight: var(--weight-bold);
    margin-bottom: var(--space-2);
    color: var(--color-text-primary);
  }

  .proposals-subtitle {
    font-size: var(--text-base);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
  }

  .proposal-stats {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
  }

  .proposal-stat {
    font-size: var(--text-sm);
    font-weight: var(--weight-medium);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }

  .proposal-stat.approved {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .proposal-stat.draft {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .proposal-stat.rejected {
    background: rgba(239, 68, 68, 0.15);
    color: var(--color-error, #ef4444);
  }

  .proposal-categories {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* Approved Proposals Section */
  .approved-proposals-section details {
    background: rgba(74, 222, 128, 0.02);
    border: 1px solid rgba(74, 222, 128, 0.15);
    border-radius: var(--radius-lg);
  }

  .approved-proposals-section details[open] {
    background: rgba(74, 222, 128, 0.03);
  }

  .status-header.approved-header h3 {
    color: var(--color-success);
  }

  .status-header.approved-header .status-icon {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  /* Draft Proposals Section */
  .draft-proposals-section details {
    background: rgba(251, 191, 36, 0.02);
    border: 1px solid rgba(251, 191, 36, 0.15);
    border-radius: var(--radius-lg);
  }

  .draft-proposals-section details[open] {
    background: rgba(251, 191, 36, 0.03);
  }

  .status-header.draft-header h3 {
    color: var(--color-warning);
  }

  .status-header.draft-header .status-icon {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  /* Rejected Proposals Section */
  .rejected-proposals-section details {
    background: rgba(239, 68, 68, 0.02);
    border: 1px solid rgba(239, 68, 68, 0.15);
    border-radius: var(--radius-lg);
  }

  .rejected-proposals-section details[open] {
    background: rgba(239, 68, 68, 0.03);
  }

  .status-header.rejected-header h3 {
    color: var(--color-error, #ef4444);
  }

  .status-header.rejected-header .status-icon {
    background: rgba(239, 68, 68, 0.15);
    color: var(--color-error, #ef4444);
  }

  .proposals-section .status-header h3 {
    font-size: var(--text-lg);
    font-weight: var(--weight-semibold);
    margin: 0;
    flex: 1;
  }

  .proposal-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-3);
    padding: 0 var(--space-4) var(--space-4);
  }

  .proposal-card {
    display: flex;
    flex-direction: column;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .proposal-card:hover {
    background: var(--color-bg-tertiary);
    border-color: var(--color-border-hover, var(--color-border));
    transform: translateY(-1px);
  }

  .proposal-card.approved {
    border-left: 3px solid var(--color-success);
  }

  .proposal-card.draft {
    border-left: 3px solid var(--color-warning);
  }

  .proposal-card.rejected {
    border-left: 3px solid var(--color-error, #ef4444);
  }

  .proposal-card h4 {
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-2) 0;
    line-height: 1.3;
  }

  .proposal-summary {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin: 0 0 var(--space-3) 0;
    flex: 1;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .proposal-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: auto;
  }


  @media (max-width: 768px) {
    .roadmap-hero h1 {
      font-size: var(--text-4xl);
    }

    .stats {
      gap: var(--space-6);
    }

    .phases {
      grid-template-columns: 1fr;
    }

    .tier {
      padding-left: var(--space-4);
    }

    .modal-body {
      padding: var(--space-3);
    }

    .modal-header-content {
      flex-direction: column;
    }

    .proposal-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
