---
import BaseLayout from '../layouts/BaseLayout.astro';

const tiers = [
  {
    id: 1,
    name: "Foundation",
    status: "complete",
    description: "Core type system and language fundamentals",
    phases: [
      { num: 1, name: "Type System Foundation", status: "complete" },
      { num: 2, name: "Type Inference", status: "complete" },
      { num: 3, name: "Traits", status: "complete" },
      { num: 4, name: "Modules", status: "partial", note: "Core complete; module alias, re-exports pending" },
      { num: 5, name: "Type Declarations", status: "partial", note: "Structs work; destructuring, sum type matching pending" },
    ],
    milestone: "M1: Bootstrapped",
    milestoneStatus: "near-complete",
    exitCriteria: "Can write programs using traits and modules",
  },
  {
    id: 2,
    name: "Capabilities & Stdlib",
    status: "partial",
    description: "Effect tracking and standard library",
    phases: [
      { num: 6, name: "Capabilities", status: "complete" },
      { num: 7, name: "Standard Library", status: "partial", note: "Collection methods done; retry, validate pending" },
    ],
    milestone: "M2: Capabilities & Stdlib",
    milestoneStatus: "partial",
    exitCriteria: "Capabilities working, stdlib available",
  },
  {
    id: 3,
    name: "Core Patterns",
    status: "in-progress",
    description: "Pattern evaluation and control flow",
    phases: [
      { num: 8, name: "Pattern Evaluation", status: "partial", note: "Data transformation done; timeout, cache, recurse pending" },
      { num: 9, name: "Match Expressions", status: "partial", note: "Guards and exhaustiveness pending" },
      { num: 10, name: "Control Flow", status: "not-started" },
    ],
    milestone: "M3: Core Patterns",
    milestoneStatus: "partial",
    exitCriteria: "All pattern and control flow constructs working",
  },
  {
    id: 4,
    name: "FFI & Interop",
    status: "planned",
    description: "Foreign code integration",
    phases: [
      { num: 11, name: "FFI", status: "not-started", note: "Critical for ecosystem" },
      { num: 12, name: "Variadic Functions", status: "not-started" },
    ],
    milestone: "M4: FFI & Interop",
    milestoneStatus: "not-started",
    exitCriteria: "Can call C libraries",
  },
  {
    id: 5,
    name: "Language Completion",
    status: "planned",
    description: "Platform support and testing framework",
    phases: [
      { num: 13, name: "Conditional Compilation", status: "not-started" },
      { num: 14, name: "Testing Framework", status: "not-started" },
      { num: 15, name: "Syntax Proposals", status: "not-started" },
    ],
    milestone: "M5: Language Complete",
    milestoneStatus: "not-started",
    exitCriteria: "All core language features complete (Phases 1-15)",
  },
  {
    id: 6,
    name: "Async & Concurrency",
    status: "future",
    description: "Async runtime and concurrent programming",
    phases: [
      { num: 16, name: "Async Support", status: "not-started" },
      { num: 17, name: "Concurrency Extended", status: "not-started", note: "Select, cancel, enhanced channels" },
    ],
    milestone: "M6: Production Async",
    milestoneStatus: "not-started",
    exitCriteria: "Can write server with graceful shutdown",
  },
  {
    id: 7,
    name: "Advanced Type System",
    status: "future",
    description: "Power-user type features",
    phases: [
      { num: 18, name: "Const Generics", status: "not-started" },
      { num: 19, name: "Existential Types", status: "not-started", note: "impl Trait" },
    ],
    milestone: "M7: Advanced Types",
    milestoneStatus: "not-started",
    exitCriteria: "Can write matrix library with compile-time checking",
  },
  {
    id: 8,
    name: "Advanced Features",
    status: "future",
    description: "Reflection, codegen, and tooling",
    phases: [
      { num: 20, name: "Reflection", status: "not-started" },
      { num: 21, name: "Code Generation", status: "not-started", note: "LLVM/Cranelift backend" },
      { num: 22, name: "Tooling", status: "not-started", note: "Formatter, LSP, REPL" },
    ],
    milestone: "M8: Full Featured",
    milestoneStatus: "not-started",
    exitCriteria: "Full IDE support, generic serialization",
  },
];

const statusLabels: Record<string, string> = {
  "complete": "Complete",
  "partial": "In Progress",
  "in-progress": "In Progress",
  "not-started": "Not Started",
  "planned": "Planned",
  "future": "Future",
  "near-complete": "Near Complete",
};

const statusColors: Record<string, string> = {
  "complete": "success",
  "partial": "warning",
  "in-progress": "warning",
  "not-started": "muted",
  "planned": "muted",
  "future": "muted",
  "near-complete": "warning",
};
---

<BaseLayout title="Roadmap — Ori">
  <main class="roadmap-page">
    <section class="roadmap-hero">
      <h1>Compiler Roadmap</h1>
      <p class="roadmap-subtitle">
        22 phases across 8 tiers. Dependency-ordered for systematic implementation.
      </p>
      <div class="stats">
        <div class="stat">
          <span class="stat-value">6</span>
          <span class="stat-label">Phases Complete</span>
        </div>
        <div class="stat">
          <span class="stat-value">5</span>
          <span class="stat-label">In Progress</span>
        </div>
        <div class="stat">
          <span class="stat-value">11</span>
          <span class="stat-label">Planned</span>
        </div>
      </div>
    </section>

    <section class="current-focus">
      <h2>Current Focus</h2>
      <div class="focus-card">
        <div class="focus-path">
          <div class="focus-step complete">
            <span class="step-num">Phase 6</span>
            <span class="step-name">Capabilities</span>
            <span class="step-status">✓ Complete</span>
          </div>
          <div class="focus-arrow">→</div>
          <div class="focus-step active">
            <span class="step-num">Phase 7</span>
            <span class="step-name">Stdlib</span>
            <span class="step-status">Collection methods done</span>
          </div>
          <div class="focus-arrow">→</div>
          <div class="focus-step pending">
            <span class="step-num">Phase 8</span>
            <span class="step-name">Patterns</span>
            <span class="step-status">Fix timeout, cache, recurse</span>
          </div>
        </div>
      </div>
    </section>

    <section class="roadmap-content">
      {tiers.map((tier) => (
        <div class="tier" data-status={tier.status}>
          <div class="tier-header">
            <div class="tier-title">
              <span class="tier-number">Tier {tier.id}</span>
              <h2>{tier.name}</h2>
              <span class={`tier-badge ${statusColors[tier.status]}`}>
                {statusLabels[tier.status]}
              </span>
            </div>
            <p class="tier-description">{tier.description}</p>
          </div>

          <div class="phases">
            {tier.phases.map((phase) => (
              <div class={`phase-card ${phase.status}`}>
                <div class="phase-header">
                  <span class="phase-num">Phase {phase.num}</span>
                  <span class={`phase-status ${statusColors[phase.status]}`}>
                    {statusLabels[phase.status]}
                  </span>
                </div>
                <h3>{phase.name}</h3>
                {phase.note && <p class="phase-note">{phase.note}</p>}
              </div>
            ))}
          </div>

          <div class="milestone">
            <div class="milestone-marker"></div>
            <div class="milestone-content">
              <span class="milestone-name">{tier.milestone}</span>
              <span class="milestone-criteria">{tier.exitCriteria}</span>
            </div>
          </div>
        </div>
      ))}
    </section>

    <section class="dependency-graph">
      <h2>Dependency Graph</h2>
      <div class="graph-container">
        <pre class="graph">{`Phase 1 (Types) → Phase 2 (Inference) → Phase 3 (Traits) → Phase 4 (Modules)
    → Phase 5 (Type Decls) → Phase 6 (Capabilities) → Phase 7 (Stdlib)
    → Phase 8 (Patterns) → Phase 9 (Match) → Phase 10 (Control Flow)
    → Phase 11 (FFI) → Phase 12 (Variadics) → Phase 13 (Conditional)
    → Phase 14 (Testing) → Phase 15 (Syntax Proposals)

Branches:
  Phase 6 ──→ Phase 16 (Async) → Phase 17 (Concurrency)
  Phase 3 ──→ Phase 19 (Existential Types)
  Phase 2 ──→ Phase 18 (Const Generics)
  Phase 11 ──→ Phase 20 (Reflection)
  Core Complete (1-15) ──→ Phase 21 (Codegen) → Phase 22 (Tooling)`}</pre>
      </div>
    </section>

    <section class="test-results">
      <h2>Current Test Results</h2>
      <div class="results-grid">
        <div class="result-card">
          <span class="result-value">1006</span>
          <span class="result-label">Rust Unit Tests</span>
          <span class="result-status success">All Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">335</span>
          <span class="result-label">Ori Spec Tests</span>
          <span class="result-status success">Passing</span>
        </div>
        <div class="result-card">
          <span class="result-value">5</span>
          <span class="result-label">Skipped</span>
          <span class="result-status muted">Pending Features</span>
        </div>
      </div>
    </section>

    <section class="roadmap-cta">
      <h2>Want to contribute?</h2>
      <p>The roadmap lives in <code>plans/sigil-compiler-roadmap/</code>. Each phase has detailed implementation tasks.</p>
      <div class="cta-buttons">
        <a href="https://github.com/upstat-io/ori-lang/tree/master/plans/sigil-compiler-roadmap" class="btn btn-primary" target="_blank" rel="noopener">View Full Roadmap</a>
        <a href="https://github.com/upstat-io/ori-lang" class="btn btn-secondary" target="_blank" rel="noopener">GitHub</a>
      </div>
    </section>
  </main>
</BaseLayout>

<style>
  .roadmap-page {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--space-8) var(--space-6) var(--space-16);
  }

  .roadmap-hero {
    text-align: center;
    padding: var(--space-12) 0 var(--space-8);
  }

  .roadmap-hero h1 {
    font-size: var(--text-5xl);
    font-weight: var(--weight-bold);
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-success) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-4);
  }

  .roadmap-subtitle {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-8);
  }

  .stats {
    display: flex;
    justify-content: center;
    gap: var(--space-8);
    flex-wrap: wrap;
  }

  .stat {
    text-align: center;
  }

  .stat-value {
    display: block;
    font-size: var(--text-4xl);
    font-weight: var(--weight-bold);
    color: var(--color-accent);
    font-family: var(--font-mono);
  }

  .stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  /* Current Focus */
  .current-focus {
    margin-bottom: var(--space-12);
  }

  .current-focus h2 {
    font-size: var(--text-xl);
    font-weight: var(--weight-semibold);
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
  }

  .focus-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    overflow-x: auto;
  }

  .focus-path {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    min-width: max-content;
  }

  .focus-step {
    display: flex;
    flex-direction: column;
    padding: var(--space-4);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
    min-width: 160px;
  }

  .focus-step.complete {
    border-left: 3px solid var(--color-success);
  }

  .focus-step.active {
    border-left: 3px solid var(--color-accent);
    background: rgba(96, 165, 250, 0.1);
  }

  .focus-step.pending {
    border-left: 3px solid var(--color-text-muted);
  }

  .step-num {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .step-name {
    font-weight: var(--weight-semibold);
    color: var(--color-text-primary);
  }

  .step-status {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin-top: var(--space-1);
  }

  .focus-arrow {
    color: var(--color-text-muted);
    font-size: var(--text-xl);
  }

  /* Tiers */
  .roadmap-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-10);
  }

  .tier {
    position: relative;
    padding-left: var(--space-6);
    border-left: 3px solid var(--color-border);
  }

  .tier[data-status="complete"] {
    border-left-color: var(--color-success);
  }

  .tier[data-status="partial"],
  .tier[data-status="in-progress"] {
    border-left-color: var(--color-accent);
  }

  .tier-header {
    margin-bottom: var(--space-4);
  }

  .tier-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
    margin-bottom: var(--space-1);
  }

  .tier-number {
    font-size: var(--text-xs);
    font-weight: var(--weight-semibold);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
  }

  .tier-title h2 {
    font-size: var(--text-xl);
    font-weight: var(--weight-bold);
    color: var(--color-text-primary);
    margin: 0;
  }

  .tier-badge {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
  }

  .tier-badge.success {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .tier-badge.warning {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .tier-badge.muted {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
  }

  .tier-description {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  /* Phases */
  .phases {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .phase-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
  }

  .phase-card.complete {
    border-left: 3px solid var(--color-success);
  }

  .phase-card.partial {
    border-left: 3px solid var(--color-warning);
  }

  .phase-card.not-started {
    border-left: 3px solid var(--color-text-muted);
    opacity: 0.7;
  }

  .phase-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
  }

  .phase-num {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    color: var(--color-text-muted);
  }

  .phase-status {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
  }

  .phase-status.success {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .phase-status.warning {
    background: rgba(251, 191, 36, 0.15);
    color: var(--color-warning);
  }

  .phase-status.muted {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
  }

  .phase-card h3 {
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text-primary);
    margin: 0;
  }

  .phase-note {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin-top: var(--space-2);
    margin-bottom: 0;
  }

  /* Milestone */
  .milestone {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-tertiary);
    border-radius: var(--radius-md);
  }

  .milestone-marker {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--color-accent);
    flex-shrink: 0;
  }

  .milestone-content {
    display: flex;
    flex-direction: column;
  }

  .milestone-name {
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-text-primary);
  }

  .milestone-criteria {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
  }

  /* Dependency Graph */
  .dependency-graph {
    margin-top: var(--space-12);
    margin-bottom: var(--space-12);
  }

  .dependency-graph h2 {
    font-size: var(--text-xl);
    font-weight: var(--weight-semibold);
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
  }

  .graph-container {
    background: var(--color-bg-code);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    overflow-x: auto;
  }

  .graph {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
    white-space: pre;
  }

  /* Test Results */
  .test-results {
    margin-bottom: var(--space-12);
  }

  .test-results h2 {
    font-size: var(--text-xl);
    font-weight: var(--weight-semibold);
    margin-bottom: var(--space-4);
    color: var(--color-text-primary);
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
  }

  .result-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    text-align: center;
  }

  .result-value {
    display: block;
    font-size: var(--text-3xl);
    font-weight: var(--weight-bold);
    font-family: var(--font-mono);
    color: var(--color-text-primary);
  }

  .result-label {
    display: block;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
  }

  .result-status {
    font-size: var(--text-xs);
    font-weight: var(--weight-medium);
    padding: 2px 8px;
    border-radius: var(--radius-full);
  }

  .result-status.success {
    background: rgba(74, 222, 128, 0.15);
    color: var(--color-success);
  }

  .result-status.muted {
    background: var(--color-bg-tertiary);
    color: var(--color-text-muted);
  }

  /* CTA */
  .roadmap-cta {
    text-align: center;
    padding: var(--space-12) var(--space-6);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-border);
  }

  .roadmap-cta h2 {
    font-size: var(--text-2xl);
    font-weight: var(--weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
  }

  .roadmap-cta p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .roadmap-cta code {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    background: var(--color-bg-code);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
    color: var(--color-accent);
  }

  .cta-buttons {
    display: flex;
    gap: var(--space-4);
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-weight: var(--weight-semibold);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .btn-primary {
    background: var(--color-accent);
    color: #fff;
  }

  .btn-primary:hover {
    background: var(--color-accent-hover);
    color: #fff;
  }

  .btn-secondary {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-bg-elevated);
    color: var(--color-text-primary);
    border-color: var(--color-border-hover);
  }

  @media (max-width: 768px) {
    .roadmap-hero h1 {
      font-size: var(--text-4xl);
    }

    .stats {
      gap: var(--space-6);
    }

    .focus-path {
      flex-direction: column;
      align-items: stretch;
    }

    .focus-arrow {
      transform: rotate(90deg);
      text-align: center;
    }

    .phases {
      grid-template-columns: 1fr;
    }

    .tier {
      padding-left: var(--space-4);
    }
  }
</style>
