# E3003: Pattern Type Error

A pattern's result type doesn't match the expected type in context.

## Example

```sigil
@factorial (n: int) -> str = recurse(    // Error: recurse returns int, not str
    condition: n <= 1,
    base: 1,
    step: n * self(n - 1)
)
```

## Explanation

Pattern expressions have a result type that depends on their arguments. This
error occurs when that result type doesn't match what's expected.

## Pattern Result Types

### `run`
Returns the type of its final expression.

```sigil
run(let x = 1, let y = 2, x + y)    // Returns int
```

### `try`
Returns `Result<T, E>` where T is the type of the final expression.

```sigil
try(let x = fallible()?, Ok(x))    // Returns Result<T, E>
```

### `match`
All arms must return the same type.

```sigil
match(option,
    Some(x) -> x,       // Returns T
    None -> default     // Must also return T
)
```

### `recurse`
Returns the type of `base` (and `step` must return the same type).

```sigil
recurse(
    condition: ...,
    base: 1,            // base is int
    step: self(...) * n // step must also be int
)
```

### `parallel`
Returns `[Result<T, E>]` where T is the return type of each task.

```sigil
parallel(tasks: [() -> fetch_a(), () -> fetch_b()])    // Returns [Result<str, E>]
```

### `timeout`
Returns `Result<T, TimeoutError>` where T is the type of `op`.

```sigil
timeout(op: compute(), after: 5s)    // Returns Result<int, TimeoutError>
```

## Common Causes

1. **Wrong return type annotation:**
   ```sigil
   // Wrong - recurse returns int
   @factorial (n: int) -> str = recurse(...)

   // Right
   @factorial (n: int) -> int = recurse(...)
   ```

2. **Mismatched match arms:**
   ```sigil
   // Wrong - arms have different types
   match(value,
       1 -> "one",        // str
       2 -> 2             // int (mismatch!)
   )

   // Right - all arms return str
   match(value,
       1 -> "one",
       2 -> "two"
   )
   ```

3. **Forgetting Result wrapper:**
   ```sigil
   // Wrong - try returns Result, not T
   @safe_div (a: int, b: int) -> int = try(...)

   // Right
   @safe_div (a: int, b: int) -> Result<int, Error> = try(...)
   ```

## Solutions

1. **Match return types:**
   ```sigil
   @factorial (n: int) -> int = recurse(
       condition: n <= 1,
       base: 1,
       step: n * self(n - 1)
   )
   ```

2. **Ensure match arms agree:**
   ```sigil
   match(status,
       Active -> "active",
       Inactive -> "inactive",
       Pending -> "pending"
   )
   ```

3. **Handle Result types:**
   ```sigil
   @fetch_or_default (url: str) -> str uses Http = run(
       let result = timeout(op: http.get(url: url), after: 5s),
       result.unwrap_or(default: "")
   )
   ```

## See Also

- E2001: Type mismatch
- E3002: Invalid pattern arguments
