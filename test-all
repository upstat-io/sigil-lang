#!/bin/bash
# Run ALL tests: Rust unit tests and Ori language tests
# Usage: ./test-all [-v|--verbose]
#
# This script runs:
# 1. All Rust unit tests (including ori_llvm, ori_rt)
# 2. Ori language spec tests (interpreter backend)
# 3. Ori language spec tests (LLVM backend)
#
# By default, only shows output for failing tests.
# Use -v or --verbose to see all output.

set -e

# Check for verbose flag
VERBOSE=0
if [[ "$1" == "-v" || "$1" == "--verbose" ]]; then
    VERBOSE=1
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Temp files for capturing output
RUST_OUTPUT=$(mktemp)
ORI_INTERP_OUTPUT=$(mktemp)
ORI_LLVM_OUTPUT=$(mktemp)

# Cleanup temp files on exit
cleanup() {
    rm -f "$RUST_OUTPUT" "$ORI_INTERP_OUTPUT" "$ORI_LLVM_OUTPUT"
}
trap cleanup EXIT

# Track if any suite failed
ANY_FAILED=0

# --- Run Rust unit tests (includes ori_llvm, ori_rt) ---
echo "=== Running Rust unit tests ==="
if [[ $VERBOSE -eq 1 ]]; then
    if cargo test --workspace 2>&1 | tee "$RUST_OUTPUT"; then
        RUST_STATUS="passed"
    else
        RUST_STATUS="FAILED"
        ANY_FAILED=1
    fi
else
    if cargo test --workspace 2>&1 > "$RUST_OUTPUT"; then
        RUST_STATUS="passed"
        # Show just the summary line
        grep -E "^test result:" "$RUST_OUTPUT" | tail -1
    else
        RUST_STATUS="FAILED"
        ANY_FAILED=1
        # Show full output on failure
        cat "$RUST_OUTPUT"
    fi
fi

# Parse Rust test results (sum all "X passed" from "test result:" lines)
RUST_PASSED=$(grep -E "^test result:" "$RUST_OUTPUT" | sed 's/.*ok\. \([0-9]*\) passed.*/\1/' | awk '{sum += $1} END {print sum+0}')
RUST_FAILED=$(grep -E "^test result:" "$RUST_OUTPUT" | sed 's/.*; \([0-9]*\) failed.*/\1/' | awk '{sum += $1} END {print sum+0}')
RUST_IGNORED=$(grep -E "^test result:" "$RUST_OUTPUT" | sed 's/.*; \([0-9]*\) ignored.*/\1/' | awk '{sum += $1} END {print sum+0}')

echo ""
echo "=== Running Ori language tests (interpreter) ==="
if [[ $VERBOSE -eq 1 ]]; then
    if cargo run -p oric --bin ori -- test tests/ 2>&1 | tee "$ORI_INTERP_OUTPUT"; then
        ORI_INTERP_STATUS="passed"
    else
        ORI_INTERP_STATUS="FAILED"
        ANY_FAILED=1
    fi
else
    if cargo run -p oric --bin ori -- test tests/ 2>&1 > "$ORI_INTERP_OUTPUT"; then
        ORI_INTERP_STATUS="passed"
        # Show just the summary line
        grep -E "[0-9]+ passed, [0-9]+ failed" "$ORI_INTERP_OUTPUT" | tail -1
    else
        ORI_INTERP_STATUS="FAILED"
        ANY_FAILED=1
        # Show full output on failure
        cat "$ORI_INTERP_OUTPUT"
    fi
fi

# Parse Ori interpreter test results (format: "  688 passed, 0 failed, 19 skipped (707 total)")
ORI_INTERP_LINE=$(grep -E "[0-9]+ passed, [0-9]+ failed" "$ORI_INTERP_OUTPUT" | tail -1)
# Extract numbers in order: passed, failed, skipped
ORI_INTERP_NUMS=($(echo "$ORI_INTERP_LINE" | grep -oE '[0-9]+'))
ORI_INTERP_PASSED="${ORI_INTERP_NUMS[0]:-0}"
ORI_INTERP_FAILED="${ORI_INTERP_NUMS[1]:-0}"
ORI_INTERP_SKIPPED="${ORI_INTERP_NUMS[2]:-0}"

echo ""
echo "=== Running Ori language tests (LLVM backend) ==="
# Build with LLVM feature first (quietly)
cargo build -p oric --features llvm --release -q 2>/dev/null || true

if [[ $VERBOSE -eq 1 ]]; then
    if ./target/release/ori test --backend=llvm tests/ 2>&1 | tee "$ORI_LLVM_OUTPUT"; then
        ORI_LLVM_STATUS="passed"
    else
        ORI_LLVM_STATUS="FAILED"
        ANY_FAILED=1
    fi
else
    if ./target/release/ori test --backend=llvm tests/ 2>&1 > "$ORI_LLVM_OUTPUT"; then
        ORI_LLVM_STATUS="passed"
        # Show just the summary line
        grep -E "[0-9]+ passed, [0-9]+ failed" "$ORI_LLVM_OUTPUT" | tail -1
    else
        ORI_LLVM_STATUS="FAILED"
        ANY_FAILED=1
        # Show full output on failure
        cat "$ORI_LLVM_OUTPUT"
    fi
fi

# Parse Ori LLVM test results (format: "  745 passed, 0 failed, 19 skipped (764 total)")
ORI_LLVM_LINE=$(grep -E "[0-9]+ passed, [0-9]+ failed" "$ORI_LLVM_OUTPUT" | tail -1)
# Extract numbers in order: passed, failed, skipped
ORI_LLVM_NUMS=($(echo "$ORI_LLVM_LINE" | grep -oE '[0-9]+'))
ORI_LLVM_PASSED="${ORI_LLVM_NUMS[0]:-0}"
ORI_LLVM_FAILED="${ORI_LLVM_NUMS[1]:-0}"
ORI_LLVM_SKIPPED="${ORI_LLVM_NUMS[2]:-0}"

# --- Print Summary ---
echo ""
echo "=============================================="
echo -e "${BOLD}                TEST SUMMARY${NC}"
echo "=============================================="
echo ""
printf "%-30s %8s %8s %8s\n" "Test Suite" "Passed" "Failed" "Skipped"
printf "%-30s %8s %8s %8s\n" "------------------------------" "--------" "--------" "--------"
printf "%-30s %8d %8d %8d\n" "Rust unit tests" "$RUST_PASSED" "$RUST_FAILED" "$RUST_IGNORED"
printf "%-30s %8d %8d %8d\n" "Ori spec (interpreter)" "$ORI_INTERP_PASSED" "$ORI_INTERP_FAILED" "$ORI_INTERP_SKIPPED"
printf "%-30s %8d %8d %8d\n" "Ori spec (LLVM backend)" "$ORI_LLVM_PASSED" "$ORI_LLVM_FAILED" "$ORI_LLVM_SKIPPED"
printf "%-30s %8s %8s %8s\n" "------------------------------" "--------" "--------" "--------"

# Calculate totals
TOTAL_PASSED=$((RUST_PASSED + ORI_INTERP_PASSED + ORI_LLVM_PASSED))
TOTAL_FAILED=$((RUST_FAILED + ORI_INTERP_FAILED + ORI_LLVM_FAILED))
TOTAL_SKIPPED=$((RUST_IGNORED + ORI_INTERP_SKIPPED + ORI_LLVM_SKIPPED))

printf "${BOLD}%-30s %8d %8d %8d${NC}\n" "TOTAL" "$TOTAL_PASSED" "$TOTAL_FAILED" "$TOTAL_SKIPPED"
echo ""

if [ "$ANY_FAILED" -eq 0 ]; then
    echo -e "${GREEN}${BOLD}=== All tests passed ===${NC}"
    exit 0
else
    echo -e "${RED}${BOLD}=== Some tests failed ===${NC}"
    exit 1
fi
