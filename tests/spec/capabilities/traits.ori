// Spec: 14-capabilities.md ยง Capability Traits
// Tests for capability traits validation

// =============================================================================
// Capability Trait Definition
// =============================================================================

// Define a capability trait with required methods
trait Http {
    @get (url: str) -> str
    @post (url: str, body: str) -> str
}

trait FileSystem {
    @read (path: str) -> str
    @write (path: str, content: str) -> void
}

trait Logger {
    @log (level: str, msg: str) -> void
}

// =============================================================================
// Functions Using Capability Traits
// =============================================================================

// Function that uses a defined capability trait
// The function calls Http.get which is provided via with...in
@fetch_data (url: str) -> str uses Http = Http.get(url: url)

// Function that uses multiple capabilities
@fetch_and_log (url: str) -> str uses Http, Logger = run(
    Logger.log(level: "info", msg: "fetching " + url),
    Http.get(url: url),
)

// Function that uses FileSystem capability
@load_config (path: str) -> str uses FileSystem = FileSystem.read(path: path)

// =============================================================================
// Capability Provider Implementation
// =============================================================================

// Struct that can be used as an Http provider
type MockHttp = { base_url: str }

impl Http for MockHttp {
    @get (self, url: str) -> str = self.base_url + url
    @post (self, url: str, body: str) -> str = self.base_url + url + ":" + body
}

// Struct that can be used as a Logger provider
type ConsoleLogger = { prefix: str }

impl Logger for ConsoleLogger {
    @log (self, level: str, msg: str) -> void = ()
}

// =============================================================================
// Tests
// =============================================================================

// Test using a capability with a valid implementation
@test_http_capability tests @fetch_data () -> void = run(
    let result = with Http = MockHttp { base_url: "https://api.example.com" } in
        fetch_data(url: "/users"),
    assert_eq(
        actual: result,
        expected: "https://api.example.com/users",
    ),
)

// Test using multiple capabilities
@test_multiple_capabilities tests @fetch_and_log () -> void = run(
    let result = with Http = MockHttp { base_url: "https://test.com" } in
        with Logger = ConsoleLogger { prefix: "[LOG]" } in
            fetch_and_log(url: "/data"),
    assert_eq(
        actual: result,
        expected: "https://test.com/data",
    ),
)

// Test that capability is accessible in body via trait methods
@test_capability_methods () -> void = run(
    let result = with Http = MockHttp { base_url: "http://localhost" } in
        Http.get(url: "/test"),
    assert_eq(
        actual: result,
        expected: "http://localhost/test",
    ),
)

// Test nested with expressions
@test_nested_with () -> void = run(
    let result = with Http = MockHttp { base_url: "outer" } in
        with Http = MockHttp { base_url: "inner" } in
            Http.base_url,
    assert_eq(
        actual: result,
        expected: "inner",
    ),
)

// Test pure function (no capabilities)
@pure_add (a: int, b: int) -> int = a + b

@test_pure_function tests @pure_add () -> void = run(
    // Pure functions don't need with...in
    assert_eq(
        actual: pure_add(a: 1, b: 2),
        expected: 3,
    ),
)
