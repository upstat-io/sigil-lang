// Spec: spec/09-expressions.md § Bitwise Operators
// Design: design/02-syntax/02-expressions.md § Bitwise
//
// Tests bitwise operations

// Helper function for testing
@bitwise_helper () -> int = 42

// =============================================================================
// Bitwise AND
// Spec: spec/09-expressions.md § "&" operator
// =============================================================================

@test_bitwise_and tests @bitwise_helper () -> void = run(
    assert_eq(0b1100 & 0b1010, 0b1000),
    assert_eq(0xFF & 0x0F, 0x0F),
    assert_eq(7 & 3, 3),
    assert_eq(12 & 0, 0),
)

// =============================================================================
// Bitwise OR
// Spec: spec/09-expressions.md § "|" operator
// =============================================================================

@test_bitwise_or tests @bitwise_helper () -> void = run(
    assert_eq(0b1100 | 0b1010, 0b1110),
    assert_eq(0xF0 | 0x0F, 0xFF),
    assert_eq(4 | 2, 6),
    assert_eq(0 | 5, 5),
)

// =============================================================================
// Bitwise XOR
// Spec: spec/09-expressions.md § "^" operator
// =============================================================================

@test_bitwise_xor tests @bitwise_helper () -> void = run(
    assert_eq(0b1100 ^ 0b1010, 0b0110),
    assert_eq(0xFF ^ 0xFF, 0),
    assert_eq(5 ^ 3, 6),
    assert_eq(7 ^ 0, 7),
)

// =============================================================================
// Bitwise NOT
// Spec: spec/09-expressions.md § "~" unary operator
// =============================================================================

@test_bitwise_not tests @bitwise_helper () -> void = run(
    assert_eq(~0, -1),
    assert_eq(~1, -2),
    assert_eq(~~5, 5),
)

// =============================================================================
// Operator Precedence
// Spec: spec/09-expressions.md § Precedence: & > ^ > |
// =============================================================================

@test_bitwise_precedence tests @bitwise_helper () -> void = run(
    assert_eq(1 | 2 & 3, 1 | (2 & 3)),
    assert_eq(1 | 2 ^ 3 & 1, 1 | (2 ^ (3 & 1))),
)

// =============================================================================
// Combined with Arithmetic
// =============================================================================

@test_bitwise_with_arithmetic tests @bitwise_helper () -> void = run(
    assert_eq(2 + 3 & 7, (2 + 3) & 7),
    assert_eq(8 | 4 - 2, 8 | (4 - 2)),
)

// =============================================================================
// Practical Use Cases
// =============================================================================

@is_even (n: int) -> bool = (n & 1) == 0

@set_bit (n: int, pos: int) -> int = n | (1 << pos)

@clear_bit (n: int, pos: int) -> int = n & ~(1 << pos)

@test_practical tests @is_even tests @set_bit tests @clear_bit () -> void = run(
    assert_eq(is_even(4), true),
    assert_eq(is_even(7), false),
)
