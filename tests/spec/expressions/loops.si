// Spec: spec/09-expressions.md § Loop Expressions
// Design: design/02-syntax/02-expressions.md § Loops
//
// Tests loop expressions

// Helper function for tests
@identity (x: int) -> int = x

// =============================================================================
// For-In Loop
// Spec: spec/09-expressions.md § for_expr = "for" identifier "in" expression "do" expression
// =============================================================================

@test_for_do tests @identity () -> void = run(
    let mut sum = 0,
    for x in [1, 2, 3, 4, 5] do
        sum = sum + x,
    assert(sum == 15),
)

// =============================================================================
// For-Yield Loop
// Spec: spec/09-expressions.md § for_expr = "for" identifier "in" expression "yield" expression
// =============================================================================

@test_for_yield tests @identity () -> void = run(
    let doubled = for x in [1, 2, 3] yield x * 2,
    assert(doubled == [2, 4, 6]),
)

@test_for_yield_transform tests @identity () -> void = run(
    let squares = for n in [1, 2, 3, 4] yield n * n,
    assert(squares == [1, 4, 9, 16]),
)

// =============================================================================
// For-Yield with Guard
// Spec: spec/09-expressions.md § for_expr = "for" identifier "in" expression "if" expression "yield" expression
// =============================================================================

@test_for_yield_guard tests @identity () -> void = run(
    let evens = for x in [1, 2, 3, 4, 5, 6] if x % 2 == 0 yield x,
    assert(evens == [2, 4, 6]),
)

@test_for_yield_guard_transform tests @identity () -> void = run(
    let result = for x in [1, 2, 3, 4, 5] if x > 2 yield x * 10,
    assert(result == [30, 40, 50]),
)

// =============================================================================
// For with Range
// Spec: spec/09-expressions.md § for over range expressions
// =============================================================================

@test_for_range tests @identity () -> void = run(
    let result = for i in 0..5 yield i,
    assert(result == [0, 1, 2, 3, 4]),
)

@test_for_range_inclusive tests @identity () -> void = run(
    let result = for i in 1..=3 yield i * i,
    assert(result == [1, 4, 9]),
)

// =============================================================================
// Loop Expression
// Spec: spec/09-expressions.md § loop_expr = "loop" "(" expression ")"
// =============================================================================

@test_loop_break tests @identity () -> void = run(
    let mut i = 0,
    let mut sum = 0,
    loop(
        if i >= 5 then break
        else run(
            sum = sum + i,
            i = i + 1,
        ),
    ),
    assert(sum == 10),
)

// =============================================================================
// Nested Loops
// =============================================================================

@test_nested_for tests @identity () -> void = run(
    let mut sum = 0,
    for i in [1, 2, 3] do
        for j in [10, 20] do
            sum = sum + i * j,
    assert(sum == 180),
)
