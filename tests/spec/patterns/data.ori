// Spec: 11-built-in-functions.md ยง Collection Methods
// Design: 02-syntax/04-patterns-reference.md ยง Collection Methods

use std.testing { assert, assert_eq, assert_ne }

// =============================================================================
// map Method on List
// =============================================================================

@test_map_double tests @map_double () -> void = run(
    let result = [1, 2, 3].map(transform: x -> x * 2),
    assert_eq(
        actual: result[0],
        expected: 2,
    ),
    assert_eq(
        actual: result[1],
        expected: 4,
    ),
    assert_eq(
        actual: result[2],
        expected: 6,
    ),
)

@map_double () -> int = 0

@test_map_to_string tests @map_to_string () -> void = run(
    let nums = [1, 2, 3],
    let strs = nums.map(transform: x -> str(x)),
    assert_eq(
        actual: strs[0],
        expected: "1",
    ),
)

@map_to_string () -> str = ""

// =============================================================================
// filter Method on List
// =============================================================================

@test_filter_positive tests @filter_positive () -> void = run(
    let nums = [1, -2, 3, -4, 5],
    let positive = nums.filter(predicate: x -> x > 0),
    assert_eq(
        actual: len(collection: positive),
        expected: 3,
    ),
    assert_eq(
        actual: positive[0],
        expected: 1,
    ),
    assert_eq(
        actual: positive[1],
        expected: 3,
    ),
    assert_eq(
        actual: positive[2],
        expected: 5,
    ),
)

@filter_positive () -> int = 0

@test_filter_even tests @filter_even () -> void = run(
    let nums = [1, 2, 3, 4, 5, 6],
    let evens = nums.filter(predicate: x -> x % 2 == 0),
    assert_eq(
        actual: len(collection: evens),
        expected: 3,
    ),
)

@filter_even () -> int = 0

// =============================================================================
// fold Method on List
// =============================================================================

@test_fold_sum tests @fold_sum () -> void = run(
    let nums = [1, 2, 3, 4, 5],
    let sum = nums.fold(
        initial: 0,
        op: (acc, x) -> acc + x,
    ),
    assert_eq(
        actual: sum,
        expected: 15,
    ),
)

@fold_sum () -> int = 0

@test_fold_product tests @fold_product () -> void = run(
    let nums = [1, 2, 3, 4],
    let product = nums.fold(
        initial: 1,
        op: (acc, x) -> acc * x,
    ),
    assert_eq(
        actual: product,
        expected: 24,
    ),
)

@fold_product () -> int = 0

// =============================================================================
// Combined Methods
// =============================================================================

@test_map_filter_chain tests @map_filter_chain () -> void = run(
    let nums = [1, 2, 3, 4, 5],
    let doubled = nums.map(transform: x -> x * 2),
    let big = doubled.filter(predicate: x -> x > 5),
    assert_eq(
        actual: len(collection: big),
        expected: 3,
    ),
)

@map_filter_chain () -> int = 0

@test_filter_map_fold tests @filter_map_fold () -> void = run(
    let nums = [1, 2, 3, 4, 5, 6],
    let evens = nums.filter(predicate: x -> x % 2 == 0),
    let squared = evens.map(transform: x -> x * x),
    let sum = squared.fold(
        initial: 0,
        op: (acc, x) -> acc + x,
    ),
    // 2^2 + 4^2 + 6^2 = 4 + 16 + 36 = 56
    assert_eq(
        actual: sum,
        expected: 56,
    ),
)

@filter_map_fold () -> int = 0

// =============================================================================
// find Method on List
// =============================================================================

@test_find_first_match tests @find_first_match () -> void = run(
    let nums = [1, 2, 3, 4, 5],
    let found = nums.find(where: x -> x > 2),
    assert(
        cond: is_some(opt: found),
    ),
)

@find_first_match () = None

@test_find_no_match tests @find_no_match () -> void = run(
    let nums = [1, 2, 3],
    let found = nums.find(where: x -> x > 10),
    assert(
        cond: is_none(opt: found),
    ),
)

@find_no_match () = None

// =============================================================================
// collect Method on Range
// =============================================================================

@test_collect_range tests @collect_range () -> void = run(
    let result = (0..5).collect(),
    assert_eq(
        actual: len(collection: result),
        expected: 5,
    ),
    assert_eq(
        actual: result[0],
        expected: 0,
    ),
    assert_eq(
        actual: result[4],
        expected: 4,
    ),
)

@collect_range () = []

@test_collect_inclusive tests @collect_inclusive () -> void = run(
    let result = (1..=3).collect(),
    assert_eq(
        actual: len(collection: result),
        expected: 3,
    ),
    assert_eq(
        actual: result[0],
        expected: 1,
    ),
    assert_eq(
        actual: result[2],
        expected: 3,
    ),
)

@collect_inclusive () = []
