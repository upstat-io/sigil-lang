// Spec: spec/10-patterns.md § Concurrency Patterns
// Design: design/02-syntax/04-patterns-reference.md § Concurrency Patterns
//
// Tests for parallel, timeout, retry, cache patterns
// NOTE: These are stub implementations - full concurrency requires async runtime

// Helper function for tests
@identity (x: int) -> int = x

// =============================================================================
// parallel - Execute tasks concurrently
// =============================================================================

// Test: parallel executes all tasks
// Spec: spec/10-patterns.md § parallel - Semantics
// Design: design/02-syntax/04-patterns-reference.md § parallel - Named Tasks
@test_parallel_executes_tasks tests @identity () -> void = run(
    let results = parallel(
        .a: 1 + 1,
        .b: 2 * 2,
    ),
    assert_eq(len(results), 2),
)

// Test: parallel with positional args
// Spec: spec/10-patterns.md § parallel - List Form
// Design: design/02-syntax/04-patterns-reference.md § parallel - Positional Tasks
@test_parallel_positional tests @identity () -> void = run(
    let results = parallel(10, 20, 30),
    assert_eq(len(results), 3),
)

// =============================================================================
// timeout - Execute with time limit
// =============================================================================

// Test: timeout returns Result
// Spec: spec/10-patterns.md § timeout - Type Signature
// Design: design/02-syntax/04-patterns-reference.md § timeout - Return Type
@test_timeout_returns_result tests @identity () -> void = run(
    let result = timeout(
        .op: 42,
        .after: 5s,
    ),
    assert_ok(result),
)

// Test: timeout wraps successful value in Ok
// Spec: spec/10-patterns.md § timeout - Semantics
// Design: design/02-syntax/04-patterns-reference.md § timeout - Success Case
@test_timeout_success tests @identity () -> void = run(
    let result = timeout(
        .op: 1 + 1,
        .after: 1s,
    ),
    assert_ok(result),
)

// =============================================================================
// retry - Retry operation on failure
// =============================================================================

// Helper function for retry tests
@always_succeed () -> int = 42

// Test: retry returns on first success
// Spec: spec/10-patterns.md § retry - Semantics
// Design: design/02-syntax/04-patterns-reference.md § retry - Success Case
@test_retry_first_success tests @always_succeed () -> void = run(
    let result = retry(
        .op: always_succeed(),
        .attempts: 3,
    ),
    assert_eq(result, 42),
)

// =============================================================================
// cache - Memoize with TTL
// =============================================================================

// Helper function for cache tests
@compute_value () -> int = 100

// Test: cache executes compute function
// Spec: spec/10-patterns.md § cache - Semantics
// Design: design/02-syntax/04-patterns-reference.md § cache - .compute Property
@test_cache_executes tests @compute_value () -> void = run(
    let result = cache(
        .key: "test",
        .compute: compute_value,
    ),
    assert_eq(result, 100),
)
