// Spec: 10-patterns.md ยง with
// Design: 02-syntax/04-patterns-reference.md ยง with

use std.testing { assert, assert_eq, assert_ne }

// =============================================================================
// with Pattern (Resource Management)
// =============================================================================

// NOTE: Release is always called even on error (RAII pattern)

@test_with_simple tests @with_simple () -> void = run(
    let result = with(
        acquire: 10,
        action: r -> r * 2,
    ),
    assert_eq(
        actual: result,
        expected: 20,
    ),
)

@with_simple () -> int = run(
    with(
        acquire: 10,
        action: r -> r * 2,
    ),
)

@test_with_transform tests @with_transform () -> void = run(
    let result = with(
        acquire: "hello",
        action: s -> len(collection: s),
    ),
    assert_eq(
        actual: result,
        expected: 5,
    ),
)

@with_transform () -> int = run(
    with(
        acquire: "hello",
        action: s -> len(collection: s),
    ),
)

@test_with_release tests @with_release () -> void = run(
    // Test that release is called (can't easily verify in tests)
    let result = with(
        acquire: 100,
        action: r -> r + 1,
        release: r -> r,
    ),
    assert_eq(
        actual: result,
        expected: 101,
    ),
)

@with_release () -> int = run(
    with(
        acquire: 100,
        action: r -> r + 1,
        release: r -> r,
    ),
)

@test_with_nested tests @with_nested () -> void = run(
    let result = with(
        acquire: 5,
        action: outer -> with(
            acquire: 3,
            action: inner -> outer + inner,
        ),
    ),
    assert_eq(
        actual: result,
        expected: 8,
    ),
)

@with_nested () -> int = run(
    with(
        acquire: 5,
        action: outer -> with(
            acquire: 3,
            action: inner -> outer + inner,
        ),
    ),
)
