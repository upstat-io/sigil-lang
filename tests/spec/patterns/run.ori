// Spec: 10-patterns.md ยง Block Expressions (formerly run)
// Block expressions replace run() for sequential execution.

use std.testing { assert, assert_eq, assert_ne }

// =============================================================================
// Block Expressions (Sequential Execution)
// =============================================================================

@test_run_simple tests @run_simple () -> void = {
    assert_eq(
        actual: run_simple(),
        expected: 3,
    )
}

@run_simple () -> int = {
    let x = 1;
    let y = 2;
    x + y
}

@test_run_with_expressions tests @run_with_expressions () -> void = {
    assert_eq(
        actual: run_with_expressions(),
        expected: 25,
    )
}

@run_with_expressions () -> int = {
    let a = 10;
    let b = a * 2;
    let c = b + 5;
    c
}

@test_run_nested tests @run_nested () -> void = {
    assert_eq(
        actual: run_nested(),
        expected: 10,
    )
}

@run_nested () -> int = {
    let outer = {
        let inner = 5;
        inner * 2
    };
    outer
}

@test_run_with_function_call tests @run_with_function_call () -> void = {
    assert_eq(
        actual: run_with_function_call(),
        expected: 10,
    )
}

@double (x: int) -> int = x * 2;

@run_with_function_call () -> int = {
    let doubled = double(5);
    doubled
}

@test_run_shadowing tests @run_shadowing () -> void = {
    assert_eq(
        actual: run_shadowing(),
        expected: 4,
    )
}

@run_shadowing () -> int = {
    let x = 1;
    let x = x + 1;
    let x = x * 2;
    x
}

// =============================================================================
// Mutable Bindings
// =============================================================================

@test_run_mutable tests @run_mutable () -> void = {
    assert_eq(
        actual: run_mutable(),
        expected: 4,
    )
}

@run_mutable () -> int = {
    let x = 1;
    x = x + 1;
    x = x * 2;
    x
}

@test_run_mutable_multiple tests @run_mutable_multiple () -> void = {
    assert_eq(
        actual: run_mutable_multiple(),
        expected: 30,
    )
}

@run_mutable_multiple () -> int = {
    let a = 10;
    let b = 20;
    a = a + 5;
    b = b - 5;
    a + b
}

// =============================================================================
// Pre-Check and Post-Check Tests
// =============================================================================
// Pre/post checks used the `run()` syntax which has been removed.
// They will return as function-level contracts (Section 15D.1).
// For now these tests are skipped.

// TODO(15D.1): Rewrite with contract syntax: @f (x: int) -> int pre(x > 0) post(r -> r >= 0) = ...

// =============================================================================
// Fallback Tests (block without checks)
// =============================================================================

@test_run_return_value tests @run_return_value () -> void = {
    let result = {
        let a = 5;
        let b = 10;
        a + b
    };
    assert_eq(actual: result, expected: 15)
}

@run_return_value () -> int = {
    let a = 5;
    let b = 10;
    a + b
}

@test_run_void tests @run_void () -> void = {
    let counter = 0;
    {
        counter = counter + 1;
        counter = counter + 2;
    };
    assert_eq(actual: counter, expected: 3)
}

@run_void () -> void = {
    let _x = 1;
    ()
}

@test_run_with_if tests @run_with_if () -> void = {
    let result = {
        let x = 5;
        if x > 0 then x * 2 else 0
    };
    assert_eq(actual: result, expected: 10)
}

@run_with_if () -> int = {
    let x = 5;
    if x > 0 then x * 2 else 0
}

@test_run_with_match tests @run_with_match () -> void = {
    let result = {
        let opt = Some(42);
        match opt {
            Some(x) -> x,
            None -> 0
        }
    };
    assert_eq(actual: result, expected: 42)
}

@run_with_match () -> int = {
    let opt = Some(42);
    match opt {
        Some(x) -> x,
        None -> 0
    }
}

@test_run_deeply_nested tests @run_deeply_nested () -> void = {
    let result = {
        let a = {
            let b = {
                let c = 5;
                c * 2
            };
            b + 3
        };
        a * 2
    };
    assert_eq(actual: result, expected: 26)
}

@run_deeply_nested () -> int = {
    let a = {
        let b = {
            let c = 5;
            c * 2
        };
        b + 3
    };
    a * 2
}
